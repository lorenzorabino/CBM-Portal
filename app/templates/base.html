<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}CBM Dashboard{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
        <style>
            /* small utilities used by templates to toggle visibility without inline style Jinja expressions */
            .hidden { display: none !important; }
            .show-inline { display: inline-flex !important; }
        </style>
        {% block extra_head %}{% endblock %}
</head>
<body class="dashboard-page with-sidebar">
    <!-- Collapsible fixed sidebar -->
    <aside id="cbmSidebar" class="cbm-sidebar" aria-label="Primary Navigation">
        <div class="sb-inner">
            <div class="sb-top">
                <button id="sbCollapse" class="sb-toggle" type="button" aria-label="Toggle sidebar" title="Collapse">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <div class="sb-brand">
                    <div class="logo">CBM</div>
                    <div class="brand-text">
                        <div class="brand-title">CBM Portal</div>
                        <div class="brand-sub">Reliability Dashboard</div>
                    </div>
                </div>
            </div>

            <nav class="sb-nav" role="navigation">
                <div class="nav-group" aria-label="Main">
                    {% if can_view('dashboard') %}
                    <a href="{{ url_for('main.index') }}" class="nav-item{% if request.endpoint == 'main.index' %} is-active{% endif %}" title="Dashboard">
                        <span class="nav-icon" aria-hidden="true">
                            <img src="{{ url_for('static', filename='icons/Dashboard.png') }}" class="icon-img default-icon">
                            <img src="{{ url_for('static', filename='icons/Dashboard.png') }}" class="icon-img active-icon">
                        </span>
                        <span class="nav-label">Dashboard</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('equipment') %}
                    <a href="{{ url_for('main.equipment_v3') }}" class="nav-item{% if request.endpoint in ['main.equipment','main.equipment_page','main.equipment_v3'] %} is-active{% endif %}" title="Equipment">
                        <span class="nav-icon" aria-hidden="true">
                            <img src="{{ url_for('static', filename='icons/Machine.png') }}" class="icon-img default-icon">
                            <img src="{{ url_for('static', filename='icons/Machine.png') }}" class="icon-img active-icon">
                        </span>
                        <span class="nav-label">Equipment</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('testing') %}
                    <a href="{{ url_for('main.testing_records') }}" class="nav-item{% if request.endpoint == 'main.testing_records' %} is-active{% endif %}" title="Testing">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h5v4l4-4h3a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg>
                        </span>
                        <span class="nav-label">Testing</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('validation') %}
                    <a href="{{ url_for('main.validation_results_alias') }}" class="nav-item{% if request.endpoint == 'main.validation_results_alias' %} is-active{% endif %}" title="Validation">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8a6 6 0 1 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        </span>
                        <span class="nav-label">Validation</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('reports') %}
                    <a href="#" class="nav-item" title="Reports" aria-disabled="true">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                        </span>
                        <span class="nav-label">Reports</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('calendar') %}
                    <a href="{{ url_for('main.calendar') }}" class="nav-item{% if request.endpoint == 'main.calendar' %} is-active{% endif %}" title="PM Calendar">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                        </span>
                        <span class="nav-label">PM Calendar</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('notifications') %}
                    <a href="{{ url_for('main.notification') }}" class="nav-item{% if request.endpoint in ['main.notification', 'main.notification_for'] %} is-active{% endif %}" title="SAP Notifications">
                        <span class="nav-icon" aria-hidden="true">
                            <img src="{{ url_for('static', filename='icons/SAP.png') }}" class="icon-img default-icon">
                            <img src="{{ url_for('static', filename='icons/SAP.png') }}" class="icon-img active-icon">
                        </span>
                        <span class="nav-label">CBM•SAP Notifications</span>
                    </a>
                </div>
                <div class="nav-group" aria-label="Management">
                    </a>
                    {% endif %}
                    {% if can_view('technicians') %}
                    <a href="{{ url_for('technician.dashboard') }}" class="nav-item{% if request.endpoint == 'technician.dashboard' %} is-active{% endif %}" title="Technicians">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
                        </span>
                        <span class="nav-label">Technicians</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('planner') %}
                    <a href="{{ url_for('main.planner_entries') }}" class="nav-item{% if request.endpoint == 'main.planner_entries' %} is-active{% endif %}" title="Planner">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
                        </span>
                        <span class="nav-label">Planner</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('notifications') %}
                    <a href="{{ url_for('main.notification') }}" class="nav-item{% if request.endpoint in ['main.notification', 'main.notification_for'] %} is-active{% endif %}" title="Notifications">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11a6 6 0 1 0-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 1 1-6 0v-1"/></svg>
                        </span>
                        <span class="nav-label">Notifications</span>
                    </a>
                    </a>
                    {% endif %}
                    {% if can_view('settings') %}
                    <a href="#" class="nav-item" title="Settings" aria-disabled="true">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 15a1.  1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c.36 0 .7.07 1 .2.39.16.6.59.6 1.02V11a2 2 0 1 1 0 4h-.09c-.43 0-.86.21-1.11.6z"/></svg>
                        </span>
                        <span class="nav-label">Settings</span>
                    </a>
                    {% endif %}
                </div>
            </nav>

            <div class="sb-bottom">
                {% set _user = session.get('user') %}
                {% if _user %}
                    <div class="nav-item" title="{{ (_user.get('user_type') or '')|title }}">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
                        </span>
                        <span class="nav-label" style="max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            {{ _user.get('name') or _user.get('employee_number') or 'User' }}
                        </span>
                    </div>
                    <a href="{{ url_for('main.change_password') }}" class="nav-item" title="Change Password">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M19.5 14a7.5 7.5 0 1 0-15 0 7.5 7.5 0 0 0 15 0Z"/></svg>
                        </span>
                        <span class="nav-label">Change Password</span>
                    </a>
                    <a href="#" id="btnLogout" class="nav-item" title="Logout">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </span>
                        <span class="nav-label">Logout</span>
                    </a>
                {% else %}
                    <a href="{{ url_for('main.login') }}" id="openLogin" class="nav-item" title="Login">
                        <span class="nav-icon" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </span>
                        <span class="nav-label">Login</span>
                    </a>
                {% endif %}
            </div>
        </div>
    </aside>

    <!-- App content shell (offsets for fixed sidebar) -->
    <div class="app-shell">
    <main class="container dashboard-layout no-sidebar">
        <div class="main-content">
            {% block content %}
            <!-- Child templates should override this block with page-specific content. -->
            {% endblock %}
        </div>
    </main>

    <footer>
        {% block footer %}
        <p>&copy; 2025 RTI - CBM Web Portal</p>
        {% endblock %}
    </footer>

    <!-- Modal root for KPI details -->
    <div id="modal-root" class="modal-root" hidden>
        <div class="modal-backdrop"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">Details</h3>
                <button type="button" class="modal-close" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-content">Loading…</div>
            </div>
        </div>
    </div>

    <!-- Login modal -->
    <div id="login-modal-root" class="modal-root" hidden>
        <div class="modal-backdrop"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="login-modal-title">
            <div class="modal-header">
                <h3 id="login-modal-title" class="modal-title">Login</h3>
                <button type="button" class="modal-close" aria-label="Close">×</button>
            </div>
            <div class="modal-body">
                <form id="login-form">
                    <div style="margin-bottom:10px;">
                        <label for="login-username" style="display:block;margin-bottom:4px;">Username</label>
                        <input id="login-username" name="username" type="text" autocomplete="username" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;" />
                    </div>
                    <div style="margin-bottom:16px;">
                        <label for="login-password" style="display:block;margin-bottom:4px;">Password</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;" />
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:8px;">
                        <button type="button" class="btn modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Sign in</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
            // Initialize progress bar widths without inline Jinja CSS expressions
            document.addEventListener('DOMContentLoaded', function(){
                document.querySelectorAll('.progress-inner').forEach(function(el){
                    var v = parseInt(el.getAttribute('data-pct') || '0', 10);
                    if (isNaN(v) || v < 0) v = 0; if (v > 100) v = 100;
                    el.style.width = v + '%';
                });

                // KPI click -> open modal with details
                const root = document.getElementById('modal-root');
                const dlg = root ? root.querySelector('.modal-dialog') : null;
                function openModal(title, innerHTML){
                    if (!root) return;
                    root.hidden = false;
                    root.querySelector('#modal-title').textContent = title || 'Details';
                    root.querySelector('.modal-content').innerHTML = innerHTML || '';
                    // focus close button for a11y
                    const closeBtn = root.querySelector('.modal-close');
                    if (closeBtn) closeBtn.focus();
                }
                function closeModal(){ if (root) root.hidden = true; }
                if (root){
                    root.addEventListener('click', (e)=>{
                        if (e.target.classList.contains('modal-backdrop') || e.target.classList.contains('modal-close')) closeModal();
                    });
                    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });
                }
                function renderItemsTable(data){
                    const items = data.items || [];
                    if (!items.length) return '<div style="color:#555; padding:8px;">No items.</div>';
                    const tc = (s) => String(s ?? '');
                    const tcase = (s) => tc(s).split(' ').map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '').join(' ');
                    const statusClass = (s) => {
                        s = (s || '').toLowerCase().trim();
                        if (s === 'completed' || s === 'done') return 'status-completed';
                        if (s === 'ongoing analysis') return 'status-analysis';
                        if (s === 'for revisit') return 'status-revisit';
                        if (s === 'waived') return 'status-waived';
                        if (s === 'sending' || s === 'sending report' || s === 'report sending' || s === 'sending-report') return 'status-sending';
                        if (s === 'ongoing') return 'status-ongoing';
                        if (s === '' || s === 'todo') return 'status-todo';
                        return 'status-todo';
                    };
                    const alarmBadge = (a) => {
                        const v = (a || '').toLowerCase().trim();
                        if (v === 'critical') return '<span class="badge alarm-critical">Critical</span>';
                        if (v === 'warning') return '<span class="badge alarm-warning">Warning</span>';
                        if (v === 'normal') return '<span class="badge alarm-normal">Normal</span>';
                        return '<span style="color:#64748b;">—</span>';
                    };
                    const schedulePill = (s) => {
                        const v = (s || '').toLowerCase().trim();
                        if (v === 'planned') return '<span class="schedule-planned">Planned</span>';
                        if (v === 'unplanned') return '<span class="schedule-unplanned">Unplanned</span>';
                        if (v === 'validation') return '<span class="schedule-validation">Validation</span>';
                        return tc(s || '-');
                    };
                    const rows = items.map(it => {
                        const st = it.status || 'todo';
                        const stCls = statusClass(st);
                        return `
                            <tr>
                                <td>#${it.id}</td>
                                <td>${(it.department || '')}/${(it.equipment || '')}</td>
                                <td>${tc(it.test_type)}</td>
                                <td><span class="${stCls}">${tcase(st)}</span></td>
                                <td>${alarmBadge(it.alarm_level)}</td>
                                <td>${schedulePill(it.schedule_type)}</td>
                                <td>${tc(it.done_date)}</td>
                            </tr>`;
                    }).join('');
                    return `
                        <div style="overflow:auto; max-height:60vh;">
                          <table class="planner-table no-wrap" style="min-width:980px;">
                            <thead><tr>
                                <th>ID</th><th>Dept/Equipment</th><th>Test Type</th><th>Status</th><th>Alarm</th><th>Schedule</th><th>Done Date</th>
                            </tr></thead>
                            <tbody>${rows}</tbody>
                          </table>
                        </div>`;
                }

                function showKpiModal(data) {
                    const items = Array.isArray(data.items) ? data.items.slice() : [];
                    const title = (data.title || 'Details') + ' — ' + (data.count || items.length || 0);
                    // Build unique option sets
                    const uniq = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b)));
                    const departments = uniq(items.map(i => (i.department || '').trim()));
                    const equipments = uniq(items.map(i => (i.equipment || '').trim()));
                    const testTypes = uniq(items.map(i => (i.test_type || '').trim()));
                    const statuses = uniq(items.map(i => (i.status || 'todo').trim().toLowerCase()));
                    const alarms = uniq(items.map(i => (i.alarm_level || '').trim().toLowerCase()));
                    const schedules = uniq(items.map(i => (i.schedule_type || '').trim().toLowerCase()));

                    const optHtml = (list, placeholder) => ['<option value="">' + placeholder + '</option>']
                        .concat(list.map(v => `<option value="${String(v)}">${String(v)}</option>`)).join('');

                                                            const toolbar = `
                                                                    <div class="panel" style="margin:0 0 8px 0; padding:8px;">
                                                                        <div style="display:flex; flex-wrap:nowrap; gap:8px; align-items:center; overflow-x:auto;">
                                                        <select id="flt-status" class="input">${optHtml(statuses, 'Any Status')}</select>
                                                        <select id="flt-alarm" class="input">${optHtml(alarms, 'Any Alarm')}</select>
                                                        <select id="flt-schedule" class="input">${optHtml(schedules, 'Any Schedule')}</select>
                                                        <input id="flt-search" class="input" placeholder="Search (ID, Dept, Equip, Type)" style="min-width:200px;" />
                                                        <button id="flt-reset" class="btn-secondary" type="button">Reset</button>
                                                        <button id="btn-download" class="btn" type="button">Download CSV</button>
                                                        <span id="flt-count" style="margin-left:auto; color:#555;"></span>
                                                    </div>
                                                </div>`;

                    const container = document.createElement('div');
                    container.innerHTML = toolbar + '<div id="kpi-table-wrap"></div>';
                    const htmlStr = container.innerHTML;
                    openModal(title, htmlStr);

                    // After injecting, wire up behavior
                    const rootEl = document;
                    const get = (sel) => (root ? root.querySelector(sel) : null);
                    const wrap = root.querySelector('#kpi-table-wrap');
                    // dept/equip/type filters removed
                    const ddlStatus = root.querySelector('#flt-status');
                    const ddlAlarm = root.querySelector('#flt-alarm');
                    const ddlSchedule = root.querySelector('#flt-schedule');
                    const txtSearch = root.querySelector('#flt-search');
                    const btnReset = root.querySelector('#flt-reset');
                    const btnDownload = root.querySelector('#btn-download');
                    const lblCount = root.querySelector('#flt-count');

                    function applyFilters() {
                        const q = (txtSearch && txtSearch.value || '').toLowerCase().trim();
                        const fDept = '';
                        const fEquip = '';
                        const fType = '';
                        const fStatus = (ddlStatus && ddlStatus.value || '').toLowerCase().trim();
                        const fAlarm = (ddlAlarm && ddlAlarm.value || '').toLowerCase().trim();
                        const fSchedule = (ddlSchedule && ddlSchedule.value || '').toLowerCase().trim();
                        return items.filter(it => {
                            const idStr = String(it.id || '');
                            const dept = String(it.department || '').toLowerCase();
                            const equip = String(it.equipment || '').toLowerCase();
                            const type = String(it.test_type || '').toLowerCase();
                            const status = String(it.status || 'todo').toLowerCase();
                            const alarm = String(it.alarm_level || '').toLowerCase();
                            const sched = String(it.schedule_type || '').toLowerCase();
                            /* dept/equip/type filters removed */
                            if (fStatus && status !== fStatus) return false;
                            if (fAlarm && alarm !== fAlarm) return false;
                            if (fSchedule && sched !== fSchedule) return false;
                            if (q) {
                                const blob = [idStr, dept, equip, type].join(' ');
                                if (!blob.includes(q)) return false;
                            }
                            return true;
                        });
                    }

                    function render() {
                        const filtered = applyFilters();
                        if (lblCount) lblCount.textContent = `${filtered.length} result(s)`;
                        wrap.innerHTML = renderItemsTable({ items: filtered });
                    }

                    function resetFilters() {
                        [ddlStatus, ddlAlarm, ddlSchedule].forEach(el => { if (el) el.value = ''; });
                        if (txtSearch) txtSearch.value = '';
                        render();
                    }

                    function toCsv(rows) {
                        const cols = ['ID','Department','Equipment','Test Type','Status','Alarm','Schedule','Done Date'];
                        const esc = (v) => {
                            const s = String(v == null ? '' : v);
                            if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                            return s;
                        };
                        const header = cols.join(',');

                    // Login modal behavior
                    (function initLoginModal(){
                        const loginRoot = document.getElementById('login-modal-root');
                        function openLogin(){
                            if (!loginRoot) return;
                            loginRoot.hidden = false;
                            const u = loginRoot.querySelector('#login-username');
                            if (u) setTimeout(()=>u.focus(), 50);
                        }
                        function closeLogin(){ if (loginRoot) loginRoot.hidden = true; }
                        // Robust: delegate click to handle dynamically rendered links
                        document.addEventListener('click', function(e){
                            const trg = e.target;
                            if (trg && trg.closest && trg.closest('#openLogin')) {
                                e.preventDefault();
                                openLogin();
                            }
                        });
                        if (loginRoot){
                            loginRoot.addEventListener('click', function(e){
                                if (e.target.classList.contains('modal-backdrop') || e.target.classList.contains('modal-close')) {
                                    closeLogin();
                                }
                            });
                            const form = loginRoot.querySelector('#login-form');
                            if (form){
                                form.addEventListener('submit', async function(e){
                                    e.preventDefault();
                                    const fd = new FormData(form);
                                    const payload = { employeeNumber: fd.get('username') || '', password: fd.get('password') || '' };
                                    try {
                                        const res = await fetch('/api/login', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(payload)
                                        });
                                        const data = await res.json().catch(() => ({ ok: false, message: 'Invalid server response' }));
                                        if (!res.ok || !data.ok) {
                                            const msg = (data && (data.message || data.error)) || 'Login failed';
                                            const root = document.getElementById('toast-root');
                                            if (root) {
                                                const div = document.createElement('div');
                                                div.className = 'toast toast-error';
                                                div.textContent = msg;
                                                root.appendChild(div);
                                                void div.offsetWidth; div.classList.add('show');
                                                setTimeout(()=>{ div.classList.remove('show'); setTimeout(()=>div.remove(), 200); }, 2500);
                                            }
                                            return;
                                        }
                                        closeLogin();
                                        // Refresh to update nav (username + links)
                                        window.location.reload();
                                    } catch (err) {
                                        const root = document.getElementById('toast-root');
                                        if (root) {
                                            const div = document.createElement('div');
                                            div.className = 'toast toast-error';
                                            div.textContent = 'Login error.';
                                            root.appendChild(div);
                                            void div.offsetWidth; div.classList.add('show');
                                            setTimeout(()=>{ div.classList.remove('show'); setTimeout(()=>div.remove(), 200); }, 2500);
                                        }
                                    }
                                });
                            }
                        }
                    })();
                        const lines = rows.map(it => [it.id, it.department, it.equipment, it.test_type, it.status, it.alarm_level, it.schedule_type, it.done_date].map(esc).join(','));
                        return [header].concat(lines).join('\n');
                    }

                    function downloadCsv() {
                        const filtered = applyFilters();
                        const csv = toCsv(filtered);
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        const wk = data.week || '{{ sel_week }}';
                        const yr = data.year || '{{ sel_year }}';
                        const kind = (data.title || 'kpi').toLowerCase().replace(/\s+/g,'_');
                        a.href = url;
                        a.download = `kpi_${kind}_W${wk}_${yr}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
                    }

                    [ddlStatus, ddlAlarm, ddlSchedule].forEach(el => { if (el) el.addEventListener('change', render); });
                    if (txtSearch) txtSearch.addEventListener('input', () => { render(); });
                    if (btnReset) btnReset.addEventListener('click', resetFilters);
                    if (btnDownload) btnDownload.addEventListener('click', downloadCsv);

                    render();
                }

                function handleKpiClick(el){
                    const type = el.getAttribute('data-kpi');
                    if (!type) return;
                    const params = new URLSearchParams({ type, week: '{{ sel_week }}', year: '{{ sel_year }}' });
                    fetch('/api/dashboard/kpi_details?' + params.toString())
                        .then(r => r.json())
                        .then(data => {
                            showKpiModal(data);
                        })
                        .catch(() => openModal('Error', '<div style="color:#b91c1c;">Failed to load details.</div>'));
                }
                document.querySelectorAll('.js-kpi').forEach(el => {
                    el.addEventListener('click', () => handleKpiClick(el));
                    el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleKpiClick(el); } });
                    el.setAttribute('tabindex', '0');
                    el.setAttribute('role', 'button');
                    el.setAttribute('aria-label', 'Open details');
                });
            });
        </script>
    <!-- Load Chart.js locally (vendored) -->
    <script src="{{ url_for('static', filename='vendor/chart.umd.min.js') }}"></script>
        <script src="{{ url_for('static', filename='main.js') }}"></script>

            <!-- Flash messages data (JSON) and renderer -->
            <script id="flash-data" type="application/json">
                {% set __msgs = get_flashed_messages(with_categories=true) %}{{ __msgs|tojson }}
            </script>
            <script type="text/javascript">
                (function() {
                    const root = document.getElementById('toast-root');
                    const dataEl = document.getElementById('flash-data');
                    if (!root || !dataEl) return;
                    let list = [];
                    try { list = JSON.parse(dataEl.textContent || '[]'); } catch (_) { list = []; }
                    function showToast(text, category) {
                        const div = document.createElement('div');
                        const cls = 'toast ' + (category ? ('toast-' + category) : 'toast-message');
                        div.className = cls;
                        div.textContent = text;
                        root.appendChild(div);
                        void div.offsetWidth;
                        div.classList.add('show');
                        setTimeout(() => { div.classList.remove('show'); setTimeout(() => div.remove(), 200); }, 1500);
                    }
                    // list is either ["msg1", ...] or [["cat","msg"], ...]
                    list.forEach(item => {
                        if (Array.isArray(item) && item.length >= 2) {
                            showToast(String(item[1] ?? ''), String(item[0] ?? 'message'));
                        } else if (typeof item === 'string') {
                            showToast(item, 'message');
                        } else if (item && typeof item === 'object') {
                            showToast(String(item.m ?? item.message ?? ''), String(item.c ?? item.category ?? 'message'));
                        }
                    });
                })();
            </script>
    <div id="toast-root" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
        (function(){
            const body = document.body;
            const sidebar = document.getElementById('cbmSidebar');
            const btnCollapse = document.getElementById('sbCollapse');
            const shell = document.querySelector('.app-shell');

            const applySidebarState = (collapsed) => {
                if (!sidebar || !shell) return;
                sidebar.classList.toggle('is-collapsed', !!collapsed);
                shell.classList.toggle('sb-collapsed', !!collapsed);
            };
            // Init from localStorage
            try {
                const collapsed = localStorage.getItem('cbm:sb-collapsed') === '1';
                applySidebarState(collapsed);
            } catch(_) {}

            if (btnCollapse) {
                // reflect initial state for assistive tech
                const initCollapsed = sidebar.classList.contains('is-collapsed');
                btnCollapse.setAttribute('aria-pressed', initCollapsed ? 'true' : 'false');
                btnCollapse.setAttribute('aria-label', initCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
                btnCollapse.setAttribute('title', initCollapsed ? 'Expand' : 'Collapse');
                // mark as wired to avoid duplicate listeners
                btnCollapse.setAttribute('data-cbm-bound','1');
                btnCollapse.addEventListener('click', () => {
                    const collapsed = !sidebar.classList.contains('is-collapsed');
                    applySidebarState(collapsed);
                    // update a11y attrs
                    btnCollapse.setAttribute('aria-pressed', collapsed ? 'true' : 'false');
                    btnCollapse.setAttribute('aria-label', collapsed ? 'Expand sidebar' : 'Collapse sidebar');
                    btnCollapse.setAttribute('title', collapsed ? 'Expand' : 'Collapse');
                    try { localStorage.setItem('cbm:sb-collapsed', collapsed ? '1' : '0'); } catch(_) {}
                });
            }
            if (btnTheme) {
                btnTheme.addEventListener('click', () => {
                    const isDark = body.classList.toggle('dark');
                    try { localStorage.setItem('cbm:theme', isDark ? 'dark' : 'light'); } catch(_) {}
                });
            }
        })();
    </script>
    <script>
        // Logout handler: POST /logout then reload
        (function(){
            document.addEventListener('click', async function(e){
                const a = e.target && e.target.closest && e.target.closest('#btnLogout');
                if (!a) return;
                e.preventDefault();
                try {
                    const res = await fetch('/logout', { method: 'POST' });
                    // Regardless of result, reload to clear session UI
                    window.location.reload();
                } catch(_) {
                    window.location.reload();
                }
            });
        })();
    </script>
    {% block extra_scripts %}{% endblock %}
    </div>
</body>
</html>
