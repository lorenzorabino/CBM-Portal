{% extends 'base.html' %}

{% block title %}Equipment â€¢ CBM Portal{% endblock %}

{% block extra_head %}
<style>
    /* Single-column layout; history appears below list when selected */
    .equipment-list.panel { padding: 12px; }
    .history-panel.panel { padding: 12px; }
    .equipment-list.minimized { max-height: 220px; overflow: auto; position: relative; }
    .equipment-list.minimized::after {
        content: 'List minimized while viewing Alarm History';
        position: sticky; bottom: 0; display:block; width:100%;
        background: var(--surface-2, rgba(0,0,0,0.04)); color: var(--text-muted, #667085);
        font-size: 12px; text-align: center; padding: 6px 8px; backdrop-filter: blur(6px);
    }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; background:#f3f4f6; margin-left:6px; }
    @media (prefers-color-scheme: dark) {
        .equipment-list.minimized::after { background: rgba(255,255,255,0.06); color:#a3a3a3; }
    }
</style>
{% endblock %}

{% block content %}
    <div class="app-shell">
        <main class="container" style="padding:16px 16px;">
            <section class="panel equipment-list {{ 'minimized' if eqid else '' }}">
                <div class="panel-title" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                    <span>Equipment</span>
                    {% if eqid %}
                    <a href="{{ url_for('main.equipment') }}?search={{ search }}" class="btn-tertiary">Clear selection</a>
                    {% endif %}
                </div>
                <form method="get" class="auto-filter-form" style="display:flex; gap:8px; align-items:center;">
                    <input class="input" type="text" name="search" placeholder="Search by Name or Department" value="{{ search }}" style="max-width:340px;" />
                    {% if eqid %}<input type="hidden" name="eqid" value="{{ eqid }}" />{% endif %}
                    <button class="btn" type="submit">Search</button>
                </form>
                <div style="overflow:auto; margin-top:8px;">
                    <table class="planner-table no-wrap" style="min-width:820px;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Machine</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Critical</th>
                                <th>Warning</th>
                                <th>Normal</th>
                                <th>Last Alarm/Date</th>
                                <th>Open</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in rows %}
                            <tr>
                                <td>{{ r.id }}</td>
                                <td>{{ r.machine }}</td>
                                <td>{{ r.department }}</td>
                                <td>{{ r.status or 'N/A' }}</td>
                                <td><span class="badge alarm-critical">Critical</span> {{ r.alarm_critical }}</td>
                                <td><span class="badge alarm-warning">Warning</span> {{ r.alarm_warning }}</td>
                                <td><span class="badge alarm-normal">Normal</span> {{ r.alarm_normal }}</td>
                                <td>{{ r.last_alarm_date or '-' }}</td>
                                <td>
                                    <a class="btn-secondary" href="{{ url_for('main.equipment') }}?search={{ search }}&eqid={{ r.id }}#history">View</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="9" style="text-align:center; color:#666;">No equipment</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="history" class="panel history-panel">
                <div class="panel-title">Alarm History</div>
                {% if selected_eq %}
                    <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <div style="font-weight:700;">{{ selected_eq.machine }} <span class="pill">{{ selected_eq.department }}</span></div>
                        <a class="btn-tertiary" href="{{ url_for('main.equipment') }}?search={{ search }}">Close</a>
                    </div>
                    <!-- Trend by Testing Type (Scatter) -->
                    {% if history %}
                    <div class="panel" style="padding:8px; margin-bottom:8px;">
                        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                            <div style="font-weight:600;">Trend by Testing Type</div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label for="typeFilter" style="color:#555;">Show Type:</label>
                                <select id="typeFilter" class="input">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-box" style="width:100%; overflow:auto;">
                            <canvas id="historyScatter" height="260"></canvas>
                        </div>
                        <script id="historyJson" type="application/json">{{ history|tojson }}</script>
                    </div>
                    {% endif %}
                    <div style="overflow:auto;">
                        <table class="planner-table no-wrap" style="min-width:680px;">
                            <thead>
                                <tr><th>ID</th><th>Type</th><th>Status</th><th>Alarm</th><th>Done Date</th><th>Week</th><th>Notes</th></tr>
                            </thead>
                            <tbody>
                                {% for h in history %}
                                <tr>
                                    <td>#{{ h.testing_id }}</td>
                                    <td>{{ h.test_type }}</td>
                                    <td class="{{ 'status-completed' if (h.status or '').lower() in ['completed','done'] else ( 'status-waived' if (h.status or '').lower()=='waived' else 'status-ongoing') }}">{{ h.status }}</td>
                                    <td>
                                        {% if (h.status or '').lower() == 'waived' %}
                                            <span class="badge status-waived">Waived</span>
                                        {% else %}
                                            <span class="badge {{ 'alarm-critical' if (h.alarm_level or '').lower()=='critical' else ('alarm-warning' if (h.alarm_level or '').lower()=='warning' else 'alarm-normal') }}">{{ h.alarm_level or 'Normal' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ h.done_tested_date or '-' }}</td>
                                    <td>{{ h.week }}</td>
                                    <td>{{ h.notes or '' }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="7" style="text-align:center; color:#666;">No alarm records</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div style="color:#666;">Select an equipment to view alarm history.</div>
                {% endif %}
            </section>
        </main>
    </div>
{% endblock %}

{% block extra_scripts %}
    <!-- Load Chart.js for the scatter chart -->
    <script src="{{ url_for('static', filename='vendor/chart.umd.min.js') }}"></script>
    <script>
        (function(){
            // Reuse sidebar collapse + theme persistence
            const body = document.body;
            const sidebar = document.getElementById('cbmSidebar');
            const btnCollapse = document.getElementById('sbCollapse');
            const btnTheme = document.getElementById('toggleTheme');
            const shell = document.querySelector('.app-shell');
            const applySidebarState = (c)=>{ if(!sidebar||!shell) return; sidebar.classList.toggle('is-collapsed', !!c); shell.classList.toggle('sb-collapsed', !!c); };
            const applyTheme = (m)=>{ body.classList.toggle('dark', m==='dark'); };
            try { applySidebarState(localStorage.getItem('cbm:sb-collapsed')==='1'); const theme=localStorage.getItem('cbm:theme'); if(theme) applyTheme(theme);} catch(_){ }
            if(btnCollapse){ btnCollapse.addEventListener('click', ()=>{ const c = !sidebar.classList.contains('is-collapsed'); applySidebarState(c); try{localStorage.setItem('cbm:sb-collapsed', c?'1':'0');}catch(_){}});}    
            if(btnTheme){ btnTheme.addEventListener('click', ()=>{ const d = body.classList.toggle('dark'); try{ localStorage.setItem('cbm:theme', d?'dark':'light'); }catch(_){ } }); }

            // If an equipment is selected but no anchor present, scroll the history into view
            try {
                var hasEq = ("{{ (eqid or '')|trim }}" !== "");
                if (hasEq && location.hash !== '#history') {
                    const el = document.getElementById('history');
                    if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
                }
            } catch(_) { }

            // Render scatter chart for Alarm History by Testing Type
            try {
                const dataEl = document.getElementById('historyJson');
                const canvas = document.getElementById('historyScatter');
                if (dataEl && canvas && window.Chart) {
                    let history = [];
                    try { history = JSON.parse(dataEl.textContent || '[]') || []; } catch(_) { history = []; }
                    // Build unique test types and datasets
                    const toStr = (v) => (v == null ? '' : String(v));
                    const types = Array.from(new Set(history.map(h => toStr(h.test_type).trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
                    // Populate filter
                    const ddl = document.getElementById('typeFilter');
                    if (ddl) {
                        types.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.textContent = t; ddl.appendChild(opt); });
                    }
                    // Convert ISO week/year or done date to ms (x-axis)
                    function isoWeekStart(y, w) {
                        // ISO week date: Week 1 is the week with the first Thursday of the year
                        const jan4 = new Date(Date.UTC(y, 0, 4));
                        const jan4Day = jan4.getUTCDay() || 7; // 1..7
                        const mondayWeek1 = new Date(jan4);
                        mondayWeek1.setUTCDate(jan4.getUTCDate() - (jan4Day - 1));
                        const ms = mondayWeek1.getTime() + (w - 1) * 7 * 86400000;
                        return new Date(ms);
                    }
                    function parseDateMs(str, year, week) {
                        const s = toStr(str).trim();
                        if (s) {
                            const d = new Date(s);
                            if (!isNaN(d.getTime())) return d.getTime();
                        }
                        if (year && week) {
                            const d = isoWeekStart(Number(year), Number(week));
                            return d.getTime();
                        }
                        return Date.now();
                    }
                    // Group by alarm level for coloring/legend; we'll use category labels directly for Y
                    const basePoints = { critical: [], warning: [], normal: [], waived: [] };
                    function normAlarm(a, status){
                        const s = toStr(status).toLowerCase().trim();
                        if (s === 'waived') return 'waived';
                        const v = toStr(a).toLowerCase().trim();
                        return v === 'critical' ? 'critical' : (v === 'warning' ? 'warning' : 'normal');
                    }
                    history.forEach(h => {
                        const t = toStr(h.test_type).trim() || 'Other';
                        if (!types.includes(t)) return; // safety
                        const y = t; // use category label directly for alignment
                        const x = parseDateMs(h.done_tested_date, h.year, h.week);
                        const key = normAlarm(h.alarm_level, h.status);
                        basePoints[key].push({ x, y, _type: t, _meta: h });
                    });
                    const color = { critical: '#dc2626', warning: '#f59e0b', normal: '#16a34a', waived: '#64748b' };
                    const radius = { critical: 5.5, warning: 4.5, normal: 3.8, waived: 4.2 };
                    const buildDatasets = (pts) => ([
                        { label: 'Critical', data: pts.critical, showLine:false, pointBackgroundColor: color.critical, pointBorderColor: color.critical, pointRadius: radius.critical, pointHoverRadius: 6 },
                        { label: 'Warning',  data: pts.warning,  showLine:false, pointBackgroundColor: color.warning,  pointBorderColor: color.warning,  pointRadius: radius.warning,  pointHoverRadius: 6 },
                        { label: 'Normal',   data: pts.normal,   showLine:false, pointBackgroundColor: color.normal,   pointBorderColor: color.normal,   pointRadius: radius.normal,   pointHoverRadius: 6 },
                        { label: 'Waived',   data: pts.waived,   showLine:false, pointBackgroundColor: color.waived,   pointBorderColor: color.waived,   pointRadius: radius.waived,   pointHoverRadius: 6 },
                    ]);
                    let datasets = buildDatasets(basePoints);
                    const ctx = canvas.getContext('2d');
                    const chart = new Chart(ctx, {
                        type: 'scatter',
                        data: { datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'nearest', intersect: false },
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: (tt) => {
                                            const r = tt.raw || {};
                                            const h = r._meta || {};
                                            const d = new Date(r.x);
                                            const dstr = isNaN(d.getTime()) ? '' : d.toISOString().slice(0,10);
                                            const typeLbl = types[r.y] || r._type || '';
                                            const lvl = tt.dataset.label || '';
                                            const id = h.testing_id ? ('#' + h.testing_id) : '';
                                            const st = h.status ? (' â€” ' + h.status) : '';
                                            return `${typeLbl}: ${dstr} â€¢ ${lvl} ${id}${st}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'linear',
                                    grid: { color: 'rgba(0,0,0,0.06)' },
                                    ticks: {
                                        callback: (v) => {
                                            const d = new Date(Number(v));
                                            return isNaN(d.getTime()) ? '' : d.toISOString().slice(0,10);
                                        },
                                    },
                                    title: { display: true, text: 'Date' }
                                },
                                y: {
                                    type: 'category',
                                    labels: types,
                                    grid: { color: 'rgba(0,0,0,0.06)' },
                                    offset: false,
                                    title: { display: true, text: 'Testing Type' }
                                }
                            }
                        }
                    });
                    if (ddl) {
                        ddl.addEventListener('change', function(){
                            const sel = (this.value || '').trim();
                            if (!sel) {
                                // reset to all points
                                chart.data.datasets = buildDatasets(basePoints);
                            } else {
                                // filter to selected type
                                const filtered = {
                                    critical: basePoints.critical.filter(p => p._type === sel),
                                    warning:  basePoints.warning.filter(p => p._type === sel),
                                    normal:   basePoints.normal.filter(p => p._type === sel),
                                    waived:   basePoints.waived.filter(p => p._type === sel),
                                };
                                chart.data.datasets = buildDatasets(filtered);
                            }
                            chart.update();
                        });
                    }
                }
            } catch(_) { /* noop */ }
        })();
    </script>
{% endblock %}