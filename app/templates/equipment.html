<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Equipment â€¢ CBM Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="{{ url_for('static', filename='main.js') }}" defer></script>
    <style>
        /* Single-column layout; history appears below list when selected */
        .equipment-list.panel { padding: 12px; }
        .history-panel.panel { padding: 12px; }
        .equipment-list.minimized { max-height: 220px; overflow: auto; position: relative; }
        .equipment-list.minimized::after {
            content: 'List minimized while viewing Alarm History';
            position: sticky; bottom: 0; display:block; width:100%;
            background: var(--surface-2, rgba(0,0,0,0.04)); color: var(--text-muted, #667085);
            font-size: 12px; text-align: center; padding: 6px 8px; backdrop-filter: blur(6px);
        }
        .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; background:#f3f4f6; margin-left:6px; }
        @media (prefers-color-scheme: dark) {
            .equipment-list.minimized::after { background: rgba(255,255,255,0.06); color:#a3a3a3; }
        }
    </style>
</head>
<body class="dashboard-page with-sidebar">
    {# reuse the same sidebar by including the built index shell quickly via a minimal header #}
    <aside id="cbmSidebar" class="cbm-sidebar" aria-label="Primary Navigation">
        <div class="sb-inner">
            <div class="sb-top">
                <button id="sbCollapse" class="sb-toggle" type="button" aria-label="Toggle sidebar" title="Collapse">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <div class="sb-brand">
                    <div class="logo">CBM</div>
                    <div class="brand-text">
                        <div class="brand-title">CBM Portal</div>
                        <div class="brand-sub">Reliability Dashboard</div>
                    </div>
                </div>
            </div>
                    <nav class="sb-nav" role="navigation">
                        <div class="nav-group" aria-label="Main">
                            <a href="{{ url_for('main.index') }}" class="nav-item" title="Dashboard">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13h8V3H3z"></path><path d="M13 21h8V11h-8z"></path><path d="M13 3h8"></path><path d="M3 21h8v-6H3z"></path></svg>
                                </span>
                                <span class="nav-label">Dashboard</span>
                            </a>
                            <a href="{{ url_for('main.equipment') }}" class="nav-item is-active" title="Equipment">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="12" rx="2"/><path d="M7 20h10"/><path d="M9 16v4"/><path d="M15 16v4"/></svg>
                                </span>
                                <span class="nav-label">Equipment</span>
                            </a>
                            <a href="{{ url_for('main.testing_records') }}" class="nav-item" title="Testing">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h5v4l4-4h3a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg>
                                </span>
                                <span class="nav-label">Testing</span>
                            </a>
                            <a href="{{ url_for('main.validation_results_alias') }}" class="nav-item" title="Validation">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8a6 6 0 1 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                                </span>
                                <span class="nav-label">Validation</span>
                            </a>
                            <a href="#" class="nav-item" aria-disabled="true" title="Reports">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                                </span>
                                <span class="nav-label">Reports</span>
                            </a>
                        </div>
                        <div class="nav-group" aria-label="Management">
                            <a href="{{ url_for('technician.dashboard') }}" class="nav-item" title="Technicians">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
                                </span>
                                <span class="nav-label">Technicians</span>
                            </a>
                            <a href="{{ url_for('main.planner_entries') }}" class="nav-item" title="Planner">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
                                </span>
                                <span class="nav-label">Planner</span>
                            </a>
                            <a href="#" class="nav-item" aria-disabled="true" title="Settings">
                                <span class="nav-icon" aria-hidden="true">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c.36 0 .7.07 1 .2.39.16.6.59.6 1.02V11a2 2 0 1 1 0 4h-.09c-.43 0-.86.21-1.11.6z"/></svg>
                                </span>
                                <span class="nav-label">Settings</span>
                            </a>
                        </div>
                    </nav>
                    <div class="sb-bottom">
                        <a href="#" class="nav-item" title="Profile">
                            <span class="nav-icon" aria-hidden="true">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-3-3.87"/><path d="M4 21v-2a4 4 0 0 1 3-3.87"/><circle cx="12" cy="7" r="4"/></svg>
                            </span>
                            <span class="nav-label">Profile</span>
                        </a>
                        <button id="toggleTheme" class="nav-item" type="button" title="Toggle Dark Mode">
                            <span class="nav-icon" aria-hidden="true">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                            </span>
                            <span class="nav-label">Dark Mode</span>
                        </button>
                        <a href="#" class="nav-item" title="Logout">
                            <span class="nav-icon" aria-hidden="true">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            </span>
                            <span class="nav-label">Logout</span>
                        </a>
                    </div>
        </div>
    </aside>

    <div class="app-shell">
        <main class="container" style="padding:16px 16px;">
            <section class="panel equipment-list {{ 'minimized' if eqid else '' }}">
                <div class="panel-title" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                    <span>Equipment</span>
                    {% if eqid %}
                    <a href="{{ url_for('main.equipment') }}?search={{ search }}" class="btn-tertiary">Clear selection</a>
                    {% endif %}
                </div>
                <form method="get" class="auto-filter-form" style="display:flex; gap:8px; align-items:center;">
                    <input class="input" type="text" name="search" placeholder="Search by Name or Department" value="{{ search }}" style="max-width:340px;" />
                    {% if eqid %}<input type="hidden" name="eqid" value="{{ eqid }}" />{% endif %}
                    <button class="btn" type="submit">Search</button>
                </form>
                <div style="overflow:auto; margin-top:8px;">
                    <table class="planner-table no-wrap" style="min-width:820px;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Machine</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Critical</th>
                                <th>Warning</th>
                                <th>Normal</th>
                                <th>Last Alarm/Date</th>
                                <th>Open</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in rows %}
                            <tr>
                                <td>{{ r.id }}</td>
                                <td>{{ r.machine }}</td>
                                <td>{{ r.department }}</td>
                                <td>{{ r.status or 'N/A' }}</td>
                                <td><span class="badge alarm-critical">Critical</span> {{ r.alarm_critical }}</td>
                                <td><span class="badge alarm-warning">Warning</span> {{ r.alarm_warning }}</td>
                                <td><span class="badge alarm-normal">Normal</span> {{ r.alarm_normal }}</td>
                                <td>{{ r.last_alarm_date or '-' }}</td>
                                <td>
                                    <a class="btn-secondary" href="{{ url_for('main.equipment') }}?search={{ search }}&eqid={{ r.id }}#history">View</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="9" style="text-align:center; color:#666;">No equipment</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="history" class="panel history-panel">
                <div class="panel-title">Alarm History</div>
                {% if selected_eq %}
                    <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <div style="font-weight:700;">{{ selected_eq.machine }} <span class="pill">{{ selected_eq.department }}</span></div>
                        <a class="btn-tertiary" href="{{ url_for('main.equipment') }}?search={{ search }}">Close</a>
                    </div>
                    <!-- Trend by Testing Type (Scatter) -->
                    {% if history %}
                    <div class="panel" style="padding:8px; margin-bottom:8px;">
                        <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                            <div style="font-weight:600;">Trend by Testing Type</div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label for="typeFilter" style="color:#555;">Show Type:</label>
                                <select id="typeFilter" class="input">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-box" style="width:100%; overflow:auto;">
                            <canvas id="historyScatter" height="260"></canvas>
                        </div>
                        <script id="historyJson" type="application/json">{{ history|tojson }}</script>
                    </div>
                    {% endif %}
                    <div style="overflow:auto;">
                        <table class="planner-table no-wrap" style="min-width:680px;">
                            <thead>
                                <tr><th>ID</th><th>Type</th><th>Status</th><th>Alarm</th><th>Done Date</th><th>Week</th><th>Notes</th></tr>
                            </thead>
                            <tbody>
                                {% for h in history %}
                                <tr>
                                    <td>#{{ h.testing_id }}</td>
                                    <td>{{ h.test_type }}</td>
                                    <td class="{{ 'status-completed' if (h.status or '').lower() in ['completed','done'] else ( 'status-waived' if (h.status or '').lower()=='waived' else 'status-ongoing') }}">{{ h.status }}</td>
                                    <td>
                                        {% if (h.status or '').lower() == 'waived' %}
                                            <span class="badge status-waived">Waived</span>
                                        {% else %}
                                            <span class="badge {{ 'alarm-critical' if (h.alarm_level or '').lower()=='critical' else ('alarm-warning' if (h.alarm_level or '').lower()=='warning' else 'alarm-normal') }}">{{ h.alarm_level or 'Normal' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ h.done_tested_date or '-' }}</td>
                                    <td>{{ h.week }}</td>
                                    <td>{{ h.notes or '' }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="7" style="text-align:center; color:#666;">No alarm records</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div style="color:#666;">Select an equipment to view alarm history.</div>
                {% endif %}
            </section>
        </main>
    </div>

    <!-- Load Chart.js for the scatter chart -->
    <script src="{{ url_for('static', filename='vendor/chart.umd.min.js') }}"></script>
    <script>
        (function(){
            // Reuse sidebar collapse + theme persistence
            const body = document.body;
            const sidebar = document.getElementById('cbmSidebar');
            const btnCollapse = document.getElementById('sbCollapse');
            const btnTheme = document.getElementById('toggleTheme');
            const shell = document.querySelector('.app-shell');
            const applySidebarState = (c)=>{ if(!sidebar||!shell) return; sidebar.classList.toggle('is-collapsed', !!c); shell.classList.toggle('sb-collapsed', !!c); };
            const applyTheme = (m)=>{ body.classList.toggle('dark', m==='dark'); };
            try { applySidebarState(localStorage.getItem('cbm:sb-collapsed')==='1'); const theme=localStorage.getItem('cbm:theme'); if(theme) applyTheme(theme);} catch(_){ }
            if(btnCollapse){ btnCollapse.addEventListener('click', ()=>{ const c = !sidebar.classList.contains('is-collapsed'); applySidebarState(c); try{localStorage.setItem('cbm:sb-collapsed', c?'1':'0');}catch(_){}});}    
            if(btnTheme){ btnTheme.addEventListener('click', ()=>{ const d = body.classList.toggle('dark'); try{ localStorage.setItem('cbm:theme', d?'dark':'light'); }catch(_){ } }); }

            // If an equipment is selected but no anchor present, scroll the history into view
            try {
                var hasEq = ("{{ (eqid or '')|trim }}" !== "");
                if (hasEq && location.hash !== '#history') {
                    const el = document.getElementById('history');
                    if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
                }
            } catch(_) { }

            // Render scatter chart for Alarm History by Testing Type
            try {
                const dataEl = document.getElementById('historyJson');
                const canvas = document.getElementById('historyScatter');
                if (dataEl && canvas && window.Chart) {
                    let history = [];
                    try { history = JSON.parse(dataEl.textContent || '[]') || []; } catch(_) { history = []; }
                    // Build unique test types and datasets
                    const toStr = (v) => (v == null ? '' : String(v));
                    const types = Array.from(new Set(history.map(h => toStr(h.test_type).trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
                    // Populate filter
                    const ddl = document.getElementById('typeFilter');
                    if (ddl) {
                        types.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.textContent = t; ddl.appendChild(opt); });
                    }
                    // Convert ISO week/year or done date to ms (x-axis)
                    function isoWeekStart(y, w) {
                        // ISO week date: Week 1 is the week with the first Thursday of the year
                        const jan4 = new Date(Date.UTC(y, 0, 4));
                        const jan4Day = jan4.getUTCDay() || 7; // 1..7
                        const mondayWeek1 = new Date(jan4);
                        mondayWeek1.setUTCDate(jan4.getUTCDate() - (jan4Day - 1));
                        const ms = mondayWeek1.getTime() + (w - 1) * 7 * 86400000;
                        return new Date(ms);
                    }
                    function parseDateMs(str, year, week) {
                        const s = toStr(str).trim();
                        if (s) {
                            const d = new Date(s);
                            if (!isNaN(d.getTime())) return d.getTime();
                        }
                        if (year && week) {
                            const d = isoWeekStart(Number(year), Number(week));
                            return d.getTime();
                        }
                        return Date.now();
                    }
                    // Group by alarm level for coloring/legend; we'll use category labels directly for Y
                    const basePoints = { critical: [], warning: [], normal: [], waived: [] };
                    function normAlarm(a, status){
                        const s = toStr(status).toLowerCase().trim();
                        if (s === 'waived') return 'waived';
                        const v = toStr(a).toLowerCase().trim();
                        return v === 'critical' ? 'critical' : (v === 'warning' ? 'warning' : 'normal');
                    }
                    history.forEach(h => {
                        const t = toStr(h.test_type).trim() || 'Other';
                        if (!types.includes(t)) return; // safety
                        const y = t; // use category label directly for alignment
                        const x = parseDateMs(h.done_tested_date, h.year, h.week);
                        const key = normAlarm(h.alarm_level, h.status);
                        basePoints[key].push({ x, y, _type: t, _meta: h });
                    });
                    const color = { critical: '#dc2626', warning: '#f59e0b', normal: '#16a34a', waived: '#64748b' };
                    const radius = { critical: 5.5, warning: 4.5, normal: 3.8, waived: 4.2 };
                    const buildDatasets = (pts) => ([
                        { label: 'Critical', data: pts.critical, showLine:false, pointBackgroundColor: color.critical, pointBorderColor: color.critical, pointRadius: radius.critical, pointHoverRadius: 6 },
                        { label: 'Warning',  data: pts.warning,  showLine:false, pointBackgroundColor: color.warning,  pointBorderColor: color.warning,  pointRadius: radius.warning,  pointHoverRadius: 6 },
                        { label: 'Normal',   data: pts.normal,   showLine:false, pointBackgroundColor: color.normal,   pointBorderColor: color.normal,   pointRadius: radius.normal,   pointHoverRadius: 6 },
                        { label: 'Waived',   data: pts.waived,   showLine:false, pointBackgroundColor: color.waived,   pointBorderColor: color.waived,   pointRadius: radius.waived,   pointHoverRadius: 6 },
                    ]);
                    let datasets = buildDatasets(basePoints);
                    const ctx = canvas.getContext('2d');
                    const chart = new Chart(ctx, {
                        type: 'scatter',
                        data: { datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'nearest', intersect: false },
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: (tt) => {
                                            const r = tt.raw || {};
                                            const h = r._meta || {};
                                            const d = new Date(r.x);
                                            const dstr = isNaN(d.getTime()) ? '' : d.toISOString().slice(0,10);
                                            const typeLbl = types[r.y] || r._type || '';
                                            const lvl = tt.dataset.label || '';
                                            const id = h.testing_id ? ('#' + h.testing_id) : '';
                                            const st = h.status ? (' â€” ' + h.status) : '';
                                            return `${typeLbl}: ${dstr} â€¢ ${lvl} ${id}${st}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'linear',
                                    grid: { color: 'rgba(0,0,0,0.06)' },
                                    ticks: {
                                        callback: (v) => {
                                            const d = new Date(Number(v));
                                            return isNaN(d.getTime()) ? '' : d.toISOString().slice(0,10);
                                        },
                                    },
                                    title: { display: true, text: 'Date' }
                                },
                                y: {
                                    type: 'category',
                                    labels: types,
                                    grid: { color: 'rgba(0,0,0,0.06)' },
                                    offset: false,
                                    title: { display: true, text: 'Testing Type' }
                                }
                            }
                        }
                    });
                    if (ddl) {
                        ddl.addEventListener('change', function(){
                            const sel = (this.value || '').trim();
                            if (!sel) {
                                // reset to all points
                                chart.data.datasets = buildDatasets(basePoints);
                            } else {
                                // filter to selected type
                                const filtered = {
                                    critical: basePoints.critical.filter(p => p._type === sel),
                                    warning:  basePoints.warning.filter(p => p._type === sel),
                                    normal:   basePoints.normal.filter(p => p._type === sel),
                                    waived:   basePoints.waived.filter(p => p._type === sel),
                                };
                                chart.data.datasets = buildDatasets(filtered);
                            }
                            chart.update();
                        });
                    }
                }
            } catch(_) { /* noop */ }
        })();
    </script>
</body>
</html>