{% extends 'technician/_planner_base.html' %}
{% block planner_content %}
<div style="margin-bottom:10px; display:flex; align-items:center; gap:12px;">
  <h2 style="margin:0;">CBM • For SAP Notifications</h2>
  <a href="{{ url_for('main.notification') }}" style="margin-left:auto;">Go to With SAP Notifications →</a>
</div>

<div class="table-wrapper">
  <table class="table planner-table">
    <thead>
      <tr>
  <th style="min-width:140px;">SAP Notification</th>
        <th>Department</th>
        <th style="min-width:auto;">Week</th>
        <th>Equipment</th>
        <th>Testing Type</th>
        <th>PM Date</th>
        <th>Scheduled type</th>
        <th>Done Tested Date</th>
        <th>Alarm Level</th>
        <th style="min-width: auto; max-width: 320px;">Notes</th>
        <th>Attachment</th>
      </tr>
    </thead>
    <tbody>
      {% if for_sap_rows %}
        {% for r in for_sap_rows %}
        <tr data-testing-id="{{ r.testing_id }}">
          <td>
            <div style="display:flex; gap:6px; align-items:center;">
              <input type="number" class="notif-input" min="0" step="1" inputmode="numeric" pattern="\d*" />
              <button type="button" class="notification-post-btn" data-testing-id="{{ r.testing_id }}">Post!</button>
            </div>
          </td>
          <td>{{ r.department or '' }}</td>
          <td class="text-center">{{ "%02d"|format(r.week_number) if r.week_number else "-" }}</td>
          <td>{{ r.equipment or '' }}</td>
          <td>{{ r.test_type or '' }}</td>
          <td class="text-center">{{ r.pm_date or '-' }}</td>
          <td class="text-center">{{ r.schedule_type or '-' }}</td>
          <td class="text-center">{{ r.done_tested_date or '-' }}</td>
          <td class="text-center"><span class="badge {{ 'alarm-critical' if (r.alarm_level or '')|lower == 'critical' else ('alarm-warning' if (r.alarm_level or '')|lower == 'warning' else 'toast-info') }}">{{ r.alarm_level }}</span></td>
          <td><div class="notes-cell">{{ r.notes or '-' }}</div></td> 
          <td>
            {% if r.attachments %}
              <ul style="list-style:none; padding:0; margin:0;">
                {% for a in r.attachments %}
                  <li style="display:inline-block; margin-right:6px;max-width: 300px;overflow-wrap: break-word;word-break: break-word;">
                    {% if a.id %}<a href="{{ url_for('technician.view_attachment', attachment_id=a.id) }}" target="_blank">{{ a.filename }}</a>{% else %}{{ a.filename }}{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="11" class="no-entries">No rows awaiting SAP notification.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<style>
  .notes-cell { white-space: normal !important; overflow-wrap: break-word; word-break: break-word; max-width: 500px; max-height: 80px; overflow-y: auto; }
  .badge { padding:4px 8px; border-radius:4px; }
  .notif-input { padding:4px 6px; border:1px solid #767676; border-radius:4px; width:90px; }
  .notif-input:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.25); }
  .notification-post-btn { background:#757576; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:600; }
  .notification-post-btn:hover { background:#1e40af; }
  .notification-post-btn:active { transform:translateY(1px); }
  .alarm-critical { color:#520000; }
  .alarm-warning { color:#ff0000; }
  .table-wrapper { width:100%; overflow-x:auto; }
  .planner-table { width:100%; min-width:900px; border-collapse:collapse; }
  .planner-table th, .planner-table td { padding:8px 10px; border-bottom:1px solid #eef2f7; vertical-align:top; }
</style>

<script>
(function(){
  async function submitNotification(btn){
    const testingId = btn.getAttribute('data-testing-id');
    const row = btn.closest('tr');
    if(!testingId || !row) return;
    const input = row.querySelector('.notif-input');
    if(!input) return; const raw=(input.value||'').trim();
    if(raw===''){ input.focus(); return; }
    if(!/^\d+$/.test(raw)){ input.classList.add('error'); return; }
    btn.disabled=true; btn.textContent='Saving...';
    try {
      const r = await fetch("{{ url_for('main.api_notification_post') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({testing_id:Number(testingId), notification:Number(raw)})});
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'failed');
      // On success, remove row from this page
      row.remove();
      const tb = document.querySelector('.planner-table tbody');
      if(tb && tb.children.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="11" class="no-entries">No rows awaiting SAP notification.</td>'; tb.appendChild(tr); }
    } catch(e){ console.warn('save failed', e); btn.disabled=false; btn.textContent='Post!'; }
  }
  // Capture-phase listener to intercept before global handlers in main.js
  document.addEventListener('click', function(e){
    const btn = e.target && (e.target.closest ? e.target.closest('.notification-post-btn') : (e.target.classList && e.target.classList.contains('notification-post-btn') ? e.target : null));
    if(!btn) return;
    e.preventDefault();
    if (e.stopImmediatePropagation) e.stopImmediatePropagation();
    e.stopPropagation();
    submitNotification(btn);
  }, true);
  document.addEventListener('input', e=>{ if(e.target && e.target.classList.contains('notif-input')){ e.target.value=e.target.value.replace(/[^0-9]/g,''); }});
})();
</script>
{% endblock %}
