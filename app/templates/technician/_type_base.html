<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ page_title }}</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/main.js" defer></script>
  <style>
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border: 1px solid #ddd; padding: 6px 8px; }
    .table thead tr { background: #f7f7f7; }
  .table th, .table td { vertical-align: middle; }
  .table th.text-left, .table td.text-left { text-align: left; }
  .table th.text-center, .table td.text-center { text-align: center; }
  /* Technician pages: full-width with slight side padding */
  .tech-container { max-width: none; margin-left: 0; margin-right: 0; padding-left: 8px; padding-right: 8px; }
    .btn {
      font: inherit;           /* copy font family, weight, and size from parent */
      line-height: 1.2;        /* consistent text height */
      padding: 4px 8px;        /* same internal spacing */
      border: 1px solid #888;
      border-radius: 4px;
      text-decoration: none;
      display: inline-flex;    /* identical layout for <a> and <button> */
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      background: #f7f7f7;
      color: #222;
      cursor: pointer;
      appearance: none;        /* remove native button look */
      -webkit-appearance: none;
      box-sizing: border-box;  /* identical sizing model */
    }
    .btn:hover { background: #eee; }
    .btn-primary { background: #1976d2; color: #fff; border-color: #1976d2; }
    /* Notes column alignment */
    td.notes-cell form.inline { flex-wrap: nowrap; }
    td.notes-cell input[type="text"] {
      padding: 4px 6px; /* match .btn vertical padding */
    }
    form.inline { display: inline-flex; gap: 6px; align-items: center; }
    select, input[type="text"] { padding: 2px 4px; }
    /* Compact height for filter controls */
    #techFilterForm input,
    #techFilterForm select {
      height: 24px;
      padding: 2px 6px;
      box-sizing: border-box;
    }
    /* Consistent width for all Alarm Level dropdowns (filter + rows) */
    select[name="alarm_level"] {
      width: 125px;       /* fits "Not Corrected" comfortably */
      min-width: 125  px;
    }
  </style>
</head>
<body>
  <!-- Toast container -->
  <div id="toast-root" class="toast-container" aria-live="polite" aria-atomic="true"></div>
  <!-- App shell with modern collapsible sidebar -->
  <aside id="cbmSidebar" class="cbm-sidebar" aria-label="Testing Navigation">
    <div class="sb-inner">
      <div class="sb-top">
        <button id="sbCollapse" class="sb-toggle" type="button" aria-label="Toggle sidebar" title="Collapse">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <div class="sb-brand">
          <div class="logo">CBM</div>
          <div class="brand-text">
            <div class="brand-title">Testing</div>
            <div class="brand-sub">KPI Dashboards</div>
          </div>
        </div>
      </div>
      <nav class="sb-nav" role="navigation">
        <div class="nav-group" aria-label="Testing">
          <a href="{{ url_for('technician.technician_vibration') }}" class="nav-item" title="Vibration Analysis">
            <span class="nav-icon" aria-hidden="true">
              <!-- Lucide / Chart icon -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 11 5 11 7 3 11 21 13 11 17 11 23 11"></polyline></svg>
            </span>
            <span class="nav-label">Vibration Analysis</span>
          </a>
          <a href="{{ url_for('technician.technician_oil') }}" class="nav-item" title="Oil Analysis">
            <span class="nav-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6"></path><path d="M8 8v6"></path><path d="M16 8v6"></path><path d="M4 20h16"></path></svg>
            </span>
            <span class="nav-label">Oil Analysis</span>
          </a>
          <a href="{{ url_for('technician.technician_thermal') }}" class="nav-item" title="Thermography">
            <span class="nav-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"></path><path d="M5 7h14"></path><path d="M5 17h14"></path></svg>
            </span>
            <span class="nav-label">Thermography</span>
          </a>
          <a href="{{ url_for('technician.technician_ultrasonic') }}" class="nav-item" title="Ultrasound">
            <span class="nav-icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a8 8 0 0 0 0-6"></path></svg>
            </span>
            <span class="nav-label">Ultrasound</span>
          </a>
        </div>
      </nav>
      <div class="sb-bottom">
        <a href="{{ url_for('main.index') }}" class="nav-item" title="SAP Notifications">
          <span class="nav-icon">üè†</span>
          <span class="nav-label">SAP Notifications</span>
        </a>
        <a href="{{ url_for('main.index') }}" class="nav-item" title="Back to Dashboard">
          <span class="nav-icon">üè†</span>
          <span class="nav-label">Dashboard</span>
        </a>
      </div>
    </div>
  </aside>

  <div class="app-shell">
  <main class="container tech-container">
  {% block content %}
    {% set ro = read_only|default(false) %}
    <div style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h2 style="margin:0;">{{ page_title }}</h2>
      <div class="date-indicator" aria-hidden="true">
        <div class="date-left"><div id="date-indicator-date" class="date-indicator-date"></div><div id="date-indicator-day" class="date-indicator-day"></div></div>
      </div>
    </div>
    <!-- Compact top nav (mobile) -->
    <nav style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <a class="btn" href="/technician/vibration">Vibration</a>
      <a class="btn" href="/technician/oil">Oil</a>
      <a class="btn" href="/technician/thermal">Thermal</a>
      <a class="btn" href="/technician/ultrasonic">Ultrasound</a>
    </nav>
    <!-- Filters -->
    <form method="get" id="techFilterForm" class="inline auto-filter-form" style="gap:8px; flex-wrap:wrap; margin-bottom:10px;">
  <input type="text" name="planner_id" value="{{ (filters.planner_id if filters) or '' }}" placeholder="ID#" style="width:50px;" />
  <input type="number" name="week_number" value="{{ (filters.week_number if filters) or '' }}" placeholder="Wk#" style="width:60px;" />
      <select name="department" style="width:160px;">
        <option value="">Department</option>
        {% for d in department_list %}
          <option value="{{ d }}" {% if filters and filters.department==d %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
      <select name="equipment" style="width:180px;">
        <option value="">Equipment</option>
        {% for e in equipment_list %}
          <option value="{{ e }}" {% if filters and filters.equipment==e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>
  <!-- PM Date filter removed -->
      <select name="schedule_type">
        <option value="">Schedule Type</option>
        <option value="Planned" {% if filters and (filters.schedule_type or '')|lower=='planned' %}selected{% endif %}>Planned</option>
        <option value="Unplanned" {% if filters and (filters.schedule_type or '')|lower=='unplanned' %}selected{% endif %}>Unplanned</option>
  <option value="Validation" {% if filters and (filters.schedule_type or '')|lower=='validation' %}selected{% endif %}>Validation</option>
      </select>
      <select name="status">
        <option value="">Status</option>
        <option value="Ongoing" {% if filters and (filters.status or '')|lower in ['ongoing','todo'] %}selected{% endif %}>Ongoing</option>
        <option value="Completed" {% if filters and (filters.status or '')|lower in ['completed','done'] %}selected{% endif %}>Completed</option>
        <option value="Ongoing Analysis" {% if filters and filters.status=='Ongoing Analysis' %}selected{% endif %}>Ongoing Analysis</option>
        <option value="For Revisit" {% if filters and filters.status=='For Revisit' %}selected{% endif %}>For Revisit</option>
        <option value="Waived" {% if filters and filters.status=='Waived' %}selected{% endif %}>Waived</option>
        <option value="Sending Report" {% if filters and filters.status=='Sending Report' %}selected{% endif %}>Sending Report</option>
      </select>
      {% set is_validation = filters and (filters.schedule_type or '')|lower == 'validation' %}
      <select name="alarm_level">
        <option value="">Alarm Level</option>
        {% if is_validation %}
          <option value="Not Corrected" {% if filters and (filters.alarm_level or '')=='Not Corrected' %}selected{% endif %}>Not Corrected</option>
          <option value="Corrected" {% if filters and filters.alarm_level=='Corrected' %}selected{% endif %}>Corrected</option>
        {% else %}
          <option value="Normal" {% if filters and (filters.alarm_level or '')=='Normal' %}selected{% endif %}>Normal</option>
          <option value="Warning" {% if filters and filters.alarm_level=='Warning' %}selected{% endif %}>Warning</option>
          <option value="Critical" {% if filters and filters.alarm_level=='Critical' %}selected{% endif %}>Critical</option>
        {% endif %}
      </select>
      <a class="btn" href="{{ request.path }}">Reset</a>
    </form>
    {% if tasks|length == 0 %}
      <p>No tasks found.</p>
    {% else %}
    <div style="overflow-x:auto;">
      <table class="table" style="white-space:nowrap;">
        <thead>
          <tr>
            <th class="text-center">Planner ID</th>
            <th class="text-center">Week #</th>
            <th class="text-left">Department</th>
            <th class="text-left">Equipment</th>
            <th class="text-left">Test Type</th>
            <th class="text-center">PM Date</th>
            <th class="text-center">Scheduled Type</th>
            <th class="text-center">Done Tested Date</th>
            <th class="text-center">Status</th>
            <th class="text-center">Alarm Level</th>
            <th class="text-left">Notes</th>
            <th class="text-center">{% if ro %}View{% else %}Upload Features{% endif %}</th>
            <th class="text-left">Files</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tasks %}
          <tr>
            <td class="text-center" title="Testing ID: {{ t.id or '' }}">{{ t.planner_id or '' }}</td>
            <td class="text-center">{{ t.week_number or '' }}</td>
            <td class="text-left">{{ t.department }}</td>
            <td class="text-left">{{ t.equipment }}</td>
            <td class="text-left">{{ t.testing_type }}</td>
            <td class="text-center">{{ t.pm_date or '' }}</td>
            <td class="text-center">
              {% set sc = (t.schedule_type or '') %}
              {% if sc %}
                {% set scl = sc|lower %}
                <span class="{{ 'schedule-planned' if scl=='planned' else ('schedule-unplanned' if scl=='unplanned' else 'schedule-validation') }}">{{ sc }}</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-center">
              {% if ro %}
                {{ ((t.done_tested_date or '')[:10]) or '-' }}
              {% else %}
                <input type="date" name="done_tested_date" form="update-{{ t.id }}" value="{{ (t.done_tested_date or '')[:10] }}" />
              {% endif %}
            </td>
            <td class="text-center">
              {% set s = (t.status or '') %}
              {% if ro %}
                {{ s or '-' }}
              {% else %}
                <select name="status" form="update-{{ t.id }}">
                  <option value="Ongoing" {% if s|lower in ['ongoing','todo'] %}selected{% endif %}>Ongoing</option>
                  <option value="Completed" {% if s|lower in ['completed','done'] %}selected{% endif %}>Completed</option>
                  <option value="Ongoing Analysis" {% if s == 'Ongoing Analysis' %}selected{% endif %}>Ongoing Analysis</option>
                  <option value="For Revisit" {% if s == 'For Revisit' %}selected{% endif %}>For Revisit</option>
                  <option value="Sending Report" {% if s == 'Sending Report' %}selected{% endif %}>Sending Report</option>
                  <option value="Waived" {% if s == 'Waived' %}selected{% endif %}>Waived</option>
                </select>
              {% endif %}
            </td>
            <td class="text-center">
              {% set scl = (t.schedule_type or '')|lower %}
              {% if scl == 'validation' %}
                {% set a = (t.alarm_level or 'Not Corrected') %}
                {% if ro %}
                  {{ a }}
                {% else %}
                  <select name="alarm_level" form="update-{{ t.id }}">
                    <option value="Not Corrected" {% if a == 'Not Corrected' %}selected{% endif %}>Not Corrected</option>
                    <option value="Corrected" {% if a == 'Corrected' %}selected{% endif %}>Corrected</option>
                  </select>
                {% endif %}
              {% else %}
                {% set a = (t.alarm_level or 'Normal') %}
                {% if ro %}
                  {{ a }}
                {% else %}
                  <select name="alarm_level" form="update-{{ t.id }}">
                    <option value="Normal" {% if a == 'Normal' %}selected{% endif %}>Normal</option>
                    <option value="Warning" {% if a == 'Warning' %}selected{% endif %}>Warning</option>
                    <option value="Critical" {% if a == 'Critical' %}selected{% endif %}>Critical</option>
                  </select>
                {% endif %}
              {% endif %}
            </td>
      <td class="text-left notes-cell" style="max-width:390px;white-space:nowrap;">
              {% if ro %}
                <div style="display:flex; align-items:center; gap:8px;">
                  <div title="Remarks" style="max-width:260px; overflow:hidden; text-overflow:ellipsis;">{{ t.notes or '' }}</div>
                </div>
              {% else %}
                <form id="update-{{ t.id }}" class="inline" method="post" action="{{ url_for('technician.task_update', task_id=t.id) }}">
                  <input type="hidden" name="next" value="{{ request.full_path }}" />
                  <input type="text" name="notes" value="{{ t.notes or '' }}" placeholder="Remarks" style="width:260px;" />
                  <button class="btn" type="submit">Save</button>
                </form>
              {% endif %}
            </td>
            <td class="text-center">
              {% if ro %}
                {% if t.planner_id %}
                  <a class="btn" href="{{ url_for('main.planner_tasks', planner_id=t.planner_id) }}" target="_blank" rel="noopener">View</a>
                {% else %}
                  -
                {% endif %}
              {% else %}
                <form class="inline" method="post" enctype="multipart/form-data" action="{{ url_for('technician.upload_attachments', task_id=t.id) }}">
                  <input type="file" name="files" multiple />
                  <button class="btn" type="submit">Upload</button>
                </form>
              {% endif %}
            </td>
            <td class="text-left" style="white-space:normal; max-width:300px;">
              {% if t.attachments and t.attachments|length > 0 %}
                <ul style="list-style:none; padding:0; margin:0;">
                  {% for f in t.attachments %}
                    <li style="display:flex; align-items:center; gap:6px; margin:2px 0;">
                      <a href="{{ url_for('technician.view_attachment', attachment_id=f.id) }}" target="_blank" rel="noopener" title="Open" style="display:inline-block; max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color:#555;">{{ f.filename }}</a>
                      {% if not ro %}
                        <form method="post" action="{{ url_for('technician.delete_attachment', attachment_id=f.id) }}" onsubmit="return confirm('Delete this file?')">
                          <button class="btn" type="submit" title="Delete">‚úï</button>
                        </form>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span style="color:#888;">No files</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  {% endblock %}
  </main>
  <script id="flashed-messages" type="application/json">
    {{ get_flashed_messages(with_categories=true)|tojson }}
  </script>
  <script type="text/javascript">
    // Render Flask flashed messages as toasts for ~1s
    (function() {
      const root = document.getElementById('toast-root');
      if (!root) return;
      // Collect flashed messages emitted by Flask as JSON
      const dataEl = document.getElementById('flashed-messages');
      let msgs = [];
      if (dataEl) {
        try {
          const arr = JSON.parse(dataEl.textContent || '[]');
          if (Array.isArray(arr)) {
            msgs = arr.map(x => ({ c: (x[0] || 'message'), m: x[1] }));
          }
        } catch (_) { /* ignore parse errors */ }
      }
      function showToast(text, category) {
        const div = document.createElement('div');
        const cls = 'toast ' + (category ? ('toast-' + category) : 'toast-message');
        div.className = cls;
        div.textContent = text;
        root.appendChild(div);
        // Force reflow to enable transition
        void div.offsetWidth;
        div.classList.add('show');
        setTimeout(() => {
          div.classList.remove('show');
          setTimeout(() => div.remove(), 200);
        }, 5000);
      }
      msgs.forEach(x => showToast(x.m, x.c));
    })();

    // Client-side guard: require Done Tested Date when Status=Completed
    (function() {
      function ensureDoneDate(e) {
        try {
          const form = e.target.closest('form');
          if (!form) return;
          const statusSel = form.querySelector('select[name="status"]');
          const dateInput = form.querySelector('input[name="done_tested_date"]');
          if (!statusSel || !dateInput) return;
          const st = (statusSel.value || '').toLowerCase();
          const dtd = (dateInput.value || '').trim();
          if ((st === 'completed' || st === 'done') && dtd === '') {
            e.preventDefault();
            // Simple modal-like alert
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.background = 'rgba(0,0,0,0.35)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '2000';
            const box = document.createElement('div');
            box.style.background = '#fff';
            box.style.padding = '16px';
            box.style.borderRadius = '8px';
            box.style.width = 'min(520px, 92vw)';
            box.innerHTML = '<h3 style="margin:0 0 8px;">Missing Done Tested Date</h3>' +
                            '<p style="margin:0 0 12px;">Please set the Done Tested Date before saving a Completed status.</p>' +
                            '<div style="display:flex; justify-content:flex-end; gap:8px;"><button id="modal-ok" class="btn btn-primary" type="button">OK</button></div>';
            overlay.appendChild(box);
            document.body.appendChild(overlay);
            // Focus the date input after dismiss
            const close = () => { overlay.remove(); dateInput.focus(); };
            box.querySelector('#modal-ok').addEventListener('click', close);
            overlay.addEventListener('click', (ev) => { if (ev.target === overlay) close(); });
          }
        } catch (_) { /* ignore */ }
      }
      // Delegate submit on all per-row update forms whose id starts with update-
      document.addEventListener('submit', function(e) {
        const f = e.target;
        if (f && f.id && f.id.startsWith('update-')) {
          ensureDoneDate(e);
        }
      }, true);
    })();
  </script>
</body>
</html>
