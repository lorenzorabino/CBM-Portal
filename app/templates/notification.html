{% extends 'base.html' %}

{% block title %}SAP Notifications • CBM Portal{% endblock %}

{% block content %}
  
  <h2 style="margin: 25px;;">CBM • SAP Notifications</h2>

  <section class="panel" style="margin-top:8px; margin-left: 8px; padding-left: 25px;">
    <script id="current-user-json" type="application/json">{{ (current_user or {}) | tojson }}</script>
    <div class="panel-title">With SAP Notifications</div>
    <div class="table-wrapper">
      <table class="table planner-table with-sap-readonly">
        <thead>
          <tr>
            <th style="min-width:100px;">Notification #</th>
            <th>Technician</th>
            <th>Department</th>
            <th style="min-width:auto;">Week</th>
            <th>Equipment</th>
            <th>Testing Type</th>
            <th>PM Date</th>
            <th>Scheduled type</th>
            <th>Done Tested Date</th>
            <th>Alarm Level</th>
            <th style="min-width: auto; max-width: 320px;">Notes</th>
            <th>Attachment</th>
          </tr>
        </thead>
        <tbody>
          {% if with_sap_rows %}
            {% for r in with_sap_rows %}
            <tr data-testing-id="{{ r.testing_id }}">
              <td>{{ r.notification }}</td>
              <td>{{ r.technician_name or '-' }}</td>
              <td>{{ r.department or '' }}</td>
              <td class="text-center">{{ "%02d"|format(r.week_number) if r.week_number else "-" }}</td>
              <td>{{ r.equipment or '' }}</td>
              <td>{{ r.test_type or '' }}</td>
              <td class="text-center">{{ r.pm_date or '-' }}</td>
              <td class="text-center">{{ r.schedule_type or '-' }}</td>
              <td class="text-center">{{ r.done_tested_date or '-' }}</td>
              <td class="text-center"><span class="badge {{ 'alarm-critical' if (r.alarm_level or '')|lower == 'critical' else ('alarm-warning' if (r.alarm_level or '')|lower == 'warning' else 'toast-info') }}">{{ r.alarm_level }}</span></td>
              <td><div class="notes-cell">{{ r.notes or '-' }}</div></td>
              <td>
                {% if r.attachments %}
                  <ul style="list-style:none; padding:0; margin:0;">
                    {% for a in r.attachments %}
                      <li style="display:inline-block; margin-right:6px;max-width: 300px;overflow-wrap: break-word;word-break: break-word;">
                        {% if a.id %}<a href="{{ url_for('technician.view_attachment', attachment_id=a.id) }}" target="_blank">{{ a.filename }}</a>{% else %}{{ a.filename }}{% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}-{% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="12" class="no-entries">No rows with SAP notification.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block extra_head %}
  <style>
    .notes-cell { white-space: normal !important; overflow-wrap: break-word; word-break: break-word; max-width: 500px; max-height: 80px; overflow-y: auto; }
    .badge { padding:4px 8px; border-radius:4px; }
    .notif-input { padding:4px 6px; border:1px solid #767676; border-radius:4px; width:90px; }
    .notif-input:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.25); }
    .notification-post-btn { background:#757576; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:600; }
    .notification-post-btn:hover { background:#1e40af; }
    .notification-post-btn:active { transform:translateY(1px); }
    .alarm-critical { color:#520000; }
    .alarm-warning { color:#ff0000; }
    .table-wrapper { width:100%; overflow-x:auto; }
    .planner-table { width:100%; min-width:900px; border-collapse:collapse; }
    .planner-table th, .planner-table td { padding:8px 10px; border-bottom:1px solid #eef2f7; vertical-align:top; }
  </style>
{% endblock %}

{% block extra_scripts %}
  <script>
  (function(){
    // Expose current user name if available
    try {
      const el = document.getElementById('current-user-json');
      const j = el ? JSON.parse(el.textContent || 'null') : null;
      window.CBM_USER_NAME = (j && j.name) ? j.name : null;
    } catch (_) { window.CBM_USER_NAME = null; }
    async function submitNotification(btn){
      const testingId = btn.getAttribute('data-testing-id');
      const row = btn.closest('tr');
      if(!testingId || !row) return;
      const input = row.querySelector('.notif-input');
      if(!input) return; const raw=(input.value||'').trim();
      if(raw===''){ input.focus(); return; }
      if(!/^\d+$/.test(raw)){ input.classList.add('error'); return; }
      btn.disabled=true; btn.textContent='Saving...';
      try {
        const r = await fetch("{{ url_for('main.api_notification_post') }}", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({testing_id:Number(testingId), notification:Number(raw)})});
        const j = await r.json();
        if(!j.ok) throw new Error(j.error||'failed');
        moveRow(row, raw, j.technician_name || (window.CBM_USER_NAME||'-'));
      } catch(e){ console.warn('save failed', e); btn.disabled=false; btn.textContent='Post it!'; }
    }
    function moveRow(row, notif, tech){
      const tbodyWith=document.querySelector('.with-sap-readonly tbody'); if(!tbodyWith) return;
      const testingId = row.getAttribute('data-testing-id');
      const existing = Array.from(tbodyWith.querySelectorAll('tr')).find(tr=>tr.getAttribute('data-testing-id')===testingId);
      const clone=document.createElement('tr');
      clone.setAttribute('data-testing-id', testingId);
      const cells=Array.from(row.querySelectorAll('td'));
      const tdNotif=document.createElement('td'); tdNotif.textContent=notif==null||notif==''?'-':notif; clone.appendChild(tdNotif);
      const tdTech=document.createElement('td'); tdTech.textContent=tech||'-'; clone.appendChild(tdTech);
      for(let i=1;i<cells.length;i++){
        const srcTd = cells[i];
        if (srcTd.querySelector && (srcTd.querySelector('.notif-input') || srcTd.querySelector('.notification-post-btn'))) {
          continue;
        }
        const newTd = srcTd.cloneNode(true);
        newTd.querySelectorAll && newTd.querySelectorAll('input,button,textarea').forEach(n=>n.remove());
        clone.appendChild(newTd);
      }
      if(existing){ tbodyWith.replaceChild(clone, existing); }
      else { tbodyWith.insertBefore(clone, tbodyWith.firstChild); }
      row.remove();
      const firstBody=document.querySelector('.planner-table tbody');
      if(firstBody && firstBody.children.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="11" class="no-entries">No rows awaiting SAP notification.</td>'; firstBody.appendChild(tr); }
    }
    document.addEventListener('click', e=>{ if(e.target && e.target.classList.contains('notification-post-btn')){ e.preventDefault(); submitNotification(e.target); }});
    document.addEventListener('input', e=>{ if(e.target && e.target.classList.contains('notif-input')){ e.target.value=e.target.value.replace(/[^0-9]/g,''); }});
  })();
  </script>
{% endblock %}
