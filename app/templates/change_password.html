{% extends 'base.html' %}

{% block title %}Change Password â€¢ CBM Portal{% endblock %}

{% block content %}
  <div class="panel" style="max-width:520px;margin:20px auto; padding:16px;">
    <h2 style="margin:0 0 12px;">Change Password</h2>
    <form id="change-pass-form">
      <div style="margin-bottom:10px;">
        <label for="cp-current" style="display:block;margin-bottom:4px;">Current password</label>
        <input id="cp-current" name="currentPassword" type="password" autocomplete="current-password" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="cp-new" style="display:block;margin-bottom:4px;">New password</label>
        <input id="cp-new" name="newPassword" type="password" autocomplete="new-password" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;" />
      </div>
      <div style="margin-bottom:16px;">
        <label for="cp-confirm" style="display:block;margin-bottom:4px;">Confirm new password</label>
        <input id="cp-confirm" name="confirmPassword" type="password" autocomplete="new-password" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;" />
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <a class="btn" href="{{ url_for('main.index') }}">Cancel</a>
        <button type="submit" class="btn btn-primary">Change Password</button>
      </div>
    </form>
    <div id="cp-message" style="margin-top:12px;color:#b91c1c;display:none;"></div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  const form = document.getElementById('change-pass-form');
  const msg = document.getElementById('cp-message');
  function showMessage(text, ok){
    if(!msg) return;
    msg.textContent = text || '';
    msg.style.display = text ? 'block' : 'none';
    msg.style.color = ok ? '#065f46' : '#b91c1c';
  }
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {
      currentPassword: (fd.get('currentPassword')||'').trim(),
      newPassword: (fd.get('newPassword')||'').trim(),
      confirmPassword: (fd.get('confirmPassword')||'').trim()
    };
    try {
  const r = await fetch("{{ url_for('main.api_change_password') }}", { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await r.json();
      if(!j.ok){ showMessage(j.message || 'Failed to change password.', false); return; }
      showMessage('Password changed successfully.', true);
      form.reset();
    } catch(err){ showMessage('Error: '+(err && err.message || 'unknown'), false); }
  });
})();
</script>
{% endblock %}
