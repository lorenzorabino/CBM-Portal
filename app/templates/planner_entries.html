<head>
    <meta charset="utf-8" />
    <title>CBM • Planner Entries</title>
    <meta name="description" content="CBM Portal Planner Entries" />
</head>
{% extends 'technician/_planner_base.html' %}
{% block planner_content %}


<!-- Filter Form -->
<form id="entriesFilterForm" class="auto-filter-form filter-form" method="GET" action="/planner_entries">
  <div class="filter-row">
    <div class="filter-group">
      <label for="filter_week">Week</label>
      <input type="number" min="1" max="52" id="filter_week" name="filter_week" value="{{ filter_week }}" placeholder="1-52" aria-label="Week">
    </div>
    <div class="filter-group">
      <label for="filter_year">Year</label>
      <input type="number" id="filter_year" name="filter_year" value="{{ filter_year }}" aria-label="Year">
    </div>
    <div class="filter-group">
      <label for="filter_department">Department</label>
      <select id="filter_department" name="filter_department">
        <option value="">All</option>
        {% for dept in department_list %}
          <option value="{{ dept }}" {% if filter_department == dept %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-group">
      <label for="filter_equipment">Equipment</label>
      <select id="filter_equipment" name="filter_equipment">
        <option value="">All</option>
        {% for eq in equipment_list %}
          <option value="{{ eq }}" {% if filter_equipment == eq %}selected{% endif %}>{{ eq }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-group">
      <label for="filter_pm_date">PM Date</label>
      <input type="date" id="filter_pm_date" name="filter_pm_date" value="{{ filter_pm_date }}">
    </div>
    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">Apply</button>
      <a href="/planner_entries" class="btn btn-ghost">Reset</a>
    </div>
  </div>
</form>

<!-- Testing Types Filter -->
<form id="typeFilterForm" class="type-filter-form" method="GET" action="/planner_entries">
  <div class="type-badges" role="group" aria-label="Testing types">
    {% for code in ['VA','OA','TI','UA','DMA','ULD','DB','Oth'] %}
      <label class="type-badge">
        <input type="checkbox" name="type_filter" value="{{ code }}"
          onchange="this.form.submit()"
          {% if code in request.args.getlist('type_filter') %}checked{% endif %}>
        <span class="badge-pill">{{ code }}</span>
      </label>
    {% endfor %}
  </div>
  <!-- Preserve other filters -->
  <input type="hidden" name="filter_week" value="{{ filter_week }}">
  <input type="hidden" name="filter_year" value="{{ filter_year }}">
  <input type="hidden" name="filter_department" value="{{ filter_department }}">
  <input type="hidden" name="filter_equipment" value="{{ filter_equipment }}">
  <input type="hidden" name="filter_pm_date" value="{{ filter_pm_date }}">
</form>

<!-- Planner Table -->
<div class="table-wrapper">
  <table class="table planner-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Week</th>
        <th>Year</th>
        <th>Department</th>
        <th>Equipment</th>
        <th>Input Date</th>
        <th>Day</th>
        <th>PM Date</th>
  <th>PM Week</th>
  <th>Schedule Type</th>
  <th>Activities</th>
  <th>Completed</th>
  <th>Status</th>
        <th>Tasks</th>
        <th>Testing Types</th>
      </tr>
    </thead>
    <tbody>
      {% for p in recent_planners %}
        <tr>
          <td class="text-center">{{ p.id }}</td>
          <td class="text-center">{{ p.week_number }}</td>
          <td class="text-center">{{ p.year }}</td>
          <td>{{ p.department }}</td>
          <td>{{ p.equipment }}</td>
          <td class="text-center">{{ p.date }}</td>
          <td class="text-center">{{ p.day }}</td>
          <td class="text-center">{{ p.pm_date }}</td>
          <td class="text-center">{{ p.pm_week_number or '' }}</td>
          <td class="text-center">
            {% if p.schedule_type %}
              {% set sc = p.schedule_type|lower %}
              <span class="schedule schedule-{{ sc }}">{{ p.schedule_type }}</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td class="text-center"><strong>{{ (p.testing_types_list | length) if p.testing_types_list else 0 }}</strong></td>
          <td class="text-center"><strong>{{ p.completed_count or 0 }}</strong></td>
          <td class="text-center"><strong>{{ p.total_tests or 0 }}</strong></td>
          <td class="text-center">
            <a class="btn btn-ghost" href="{{ url_for('main.planner_tasks', planner_id=p.id) }}">View</a>
          </td>
          <td>
            <button type="button" class="btn btn-add" title="Add Test Type" data-pid="{{ p.id }}" data-action="open-modal">+</button>
            {% if p.testing_types_list %}
              {% for t in p.testing_types_list %}
                {% set key = t.lower() %}
                {% if 'vibration' in key %}
                  {% set cls, cat = 'va', 'vibration' %}
                {% elif 'oil' in key %}
                  {% set cls, cat = 'oil', 'oil' %}
                {% elif 'thermal' in key %}
                  {% set cls, cat = 'thermal', 'thermal' %}
                {% elif 'ultrasonic leak' in key %}
                  {% set cls, cat = 'leak', 'leak_detection' %}
                {% elif 'ultrasonic' in key %}
                  {% set cls, cat = 'ultra', 'ultrasonic' %}
                {% elif 'motor dynamic' in key %}
                  {% set cls, cat = 'mda', 'motor_dynamic' %}
                {% elif 'balancing' in key %}
                  {% set cls, cat = 'balance', 'balancing' %}
                {% else %}
                  {% set cls, cat = 'other', 'other' %}
                {% endif %}
                <span class="tag-wrapper">
                  <a class="tag tag-{{ cls }}" href="{{ url_for('technician.by_category', category=cat, planner_id=p.id) }}">{{ t }}</a>
                  <form method="post" action="{{ url_for('main.remove_test_type', planner_id=p.id) }}" onsubmit="return confirm('Remove {{ t }} from this row?')" class="inline-form">
                    <input type="hidden" name="test_type" value="{{ t }}">
                    <input type="hidden" name="next" value="{{ request.full_path }}">
                    <button type="submit" class="remove-btn" title="Remove">×</button>
                  </form>
                </span>
              {% endfor %}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      {% if recent_planners|length == 0 %}
        <tr><td colspan="15" class="no-entries">No entries found.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Add Test Type Modal -->
<div id="addTypeModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-dialog" role="document" aria-labelledby="addTypeTitle">
    <header class="modal-header">
      <h3 id="addTypeTitle">Add Testing Type</h3>
      <button type="button" class="close-btn" aria-label="Close modal" data-action="close-modal">×</button>
    </header>
    <form id="addTypeForm" method="post" action="/planner/add_test_type" class="modal-form">
      <input type="hidden" name="planner_id" id="addTypePlannerId">
      <input type="hidden" name="next" value="{{ request.full_path }}">
      <label class="field">
        <span class="field-label">Select type</span>
        <select name="test_type" id="addTypeSelect" required>
          <option value="">-- Choose --</option>
          <option>Vibration Analysis</option>
          <option>Oil Analysis</option>
          <option>Thermal Imaging</option>
          <option>Ultrasonic Analysis</option>
          <option>Motor Dynamic Analysis</option>
          <option>Ultrasonic Leak Detection</option>
          <option>Dynamic Balancing</option>
          <option>Other</option>
        </select>
      </label>
      <div class="actions">
        <button type="button" class="btn btn-ghost" data-action="close-modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('entriesFilterForm');
    ['filter_department','filter_equipment','filter_pm_date'].forEach(id => {
      const el = document.getElementById(id);
      if (el && form) {
        el.addEventListener('change', () => {
          if (form.requestSubmit) form.requestSubmit(); else form.submit();
        });
      }
    });

    // Modal behavior: open/close by data attributes for accessibility
    const modal = document.getElementById('addTypeModal');
    const pidInput = document.getElementById('addTypePlannerId');
    const selectEl = document.getElementById('addTypeSelect');

    function openAddTypeModal(plannerId){
      if(!modal || !pidInput || !selectEl) return;
      pidInput.value = plannerId;
      selectEl.value = '';
      modal.classList.remove('hidden');
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      // trap focus to select
      selectEl.focus();
    }
    function closeAddTypeModal(){
      if(!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }

    // Delegate open buttons
    document.body.addEventListener('click', function(e){
      const t = e.target.closest('[data-action="open-modal"]');
      if(t){
        const pid = t.getAttribute('data-pid');
        openAddTypeModal(pid);
        return;
      }
      if(e.target.closest('[data-action="close-modal"]') || e.target.getAttribute('data-action')==='close-modal'){
        closeAddTypeModal();
      }
      if(e.target.getAttribute('data-action')==='open-modal'){
        openAddTypeModal(e.target.dataset.pid);
      }
    });

    // backdrop click and escape
    modal && modal.addEventListener('click', function(e){ if(e.target === modal) closeAddTypeModal(); });
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeAddTypeModal(); });

    // expose old-named function for compatibility
    window.openAddTypeModal = function(pid){ openAddTypeModal(pid); };
    window.closeAddTypeModal = function(){ closeAddTypeModal(); };
  });
</script>

{% endblock %}
