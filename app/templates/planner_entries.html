{% extends 'technician/_type_base.html' %}
{% block content %}

  <!-- Filter Form -->
  <form id="entriesFilterForm" class="auto-filter-form filter-form" method="GET" action="/planner_entries">
      <label for="filter_week">Week:</label>
      <input type="number" min="1" max="52" id="filter_week" name="filter_week" value="{{ filter_week }}" placeholder="1-52">

      <label for="filter_year">Year:</label>
      <input type="number" id="filter_year" name="filter_year" value="{{ filter_year }}">

      <label for="filter_department">Department:</label>
      <select id="filter_department" name="filter_department">
        <option value="">All</option>
        {% for dept in department_list %}
          <option value="{{ dept }}" {% if filter_department == dept %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>

      <label for="filter_equipment">Equipment:</label>
      <select id="filter_equipment" name="filter_equipment">
        <option value="">All</option>
        {% for eq in equipment_list %}
          <option value="{{ eq }}" {% if filter_equipment == eq %}selected{% endif %}>{{ eq }}</option>
        {% endfor %}
      </select>

      <label for="filter_pm_date">PM Date:</label>
      <input type="date" id="filter_pm_date" name="filter_pm_date" value="{{ filter_pm_date }}">

      <a href="/planner_entries" class="btn reset-btn">Reset</a>
  </form>

  <!-- Testing Types Filter -->
  <form id="typeFilterForm" class="type-filter-form" method="GET" action="/planner_entries">
    <div class="type-badges">
      {% for code in ['VA','OA','TI','UA','DMA','ULD','DB','Oth'] %}
        <label>
          <input type="checkbox" name="type_filter" value="{{ code }}"
            onchange="this.form.submit()"
            {% if code in request.args.getlist('type_filter') %}checked{% endif %}>
          {{ code }}
        </label>
      {% endfor %}
    </div>
    <!-- Preserve other filters -->
    <input type="hidden" name="filter_week" value="{{ filter_week }}">
    <input type="hidden" name="filter_year" value="{{ filter_year }}">
    <input type="hidden" name="filter_department" value="{{ filter_department }}">
    <input type="hidden" name="filter_equipment" value="{{ filter_equipment }}">
    <input type="hidden" name="filter_pm_date" value="{{ filter_pm_date }}">
  </form>

  <!-- Planner Table -->
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Week</th>
          <th>Year</th>
          <th>Department</th>
          <th>Equipment</th>
          <th>Input Date</th>
          <th>Day</th>
          <th>PM Date</th>
          <th>PM Week</th>
          <th>Schedule Type</th>
          <th>Status/Alarm</th>
          <th>Tasks</th>
          <th>Testing Types</th>
        </tr>
      </thead>
      <tbody>
        {% for p in recent_planners %}
          <tr>
            <td class="text-center">{{ p.id }}</td>
            <td class="text-center">{{ p.week_number }}</td>
            <td class="text-center">{{ p.year }}</td>
            <td>{{ p.department }}</td>
            <td>{{ p.equipment }}</td>
            <td class="text-center">{{ p.date }}</td>
            <td class="text-center">{{ p.day }}</td>
            <td class="text-center">{{ p.pm_date }}</td>
            <td class="text-center">{{ p.pm_week_number or '' }}</td>
            <td class="text-center">
              {% if p.schedule_type %}
                {% set sc = p.schedule_type|lower %}
                <span class="schedule {{ sc }}">{{ p.schedule_type }}</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-center">
              <span class="badge">Completed: {{ p.completed_count or 0 }}/{{ p.total_tests or 0 }}</span>
              <span class="badge">Alarm: {{ p.alarm_filled or 0 }}/{{ p.total_tests or 0 }}</span>
              {% if p.worst_alarm %}
                <span class="badge alarm-{{ p.worst_alarm|lower }}">{{ p.worst_alarm }}</span>
              {% endif %}
            </td>
            <td class="text-center">
              <a class="btn" href="{{ url_for('main.planner_tasks', planner_id=p.id) }}">View</a>
            </td>
            <td>
              <button type="button" class="btn" title="Add Test Type" data-pid="{{ p.id }}" onclick="openAddTypeModal(this.dataset.pid)">+</button>
              {% if p.testing_types_list %}
                {% for t in p.testing_types_list %}
                  {% set key = t.lower() %}
                  {% if 'vibration' in key %}
                    {% set cls, cat = 'va', 'vibration' %}
                  {% elif 'oil' in key %}
                    {% set cls, cat = 'oil', 'oil' %}
                  {% elif 'thermal' in key %}
                    {% set cls, cat = 'thermal', 'thermal' %}
                  {% elif 'ultrasonic leak' in key %}
                    {% set cls, cat = 'leak', 'leak_detection' %}
                  {% elif 'ultrasonic' in key %}
                    {% set cls, cat = 'ultra', 'ultrasonic' %}
                  {% elif 'motor dynamic' in key %}
                    {% set cls, cat = 'mda', 'motor_dynamic' %}
                  {% elif 'balancing' in key %}
                    {% set cls, cat = 'balance', 'balancing' %}
                  {% else %}
                    {% set cls, cat = 'other', 'other' %}
                  {% endif %}
                  <span class="tag-wrapper">
                    <a class="tag {{ cls }}" href="{{ url_for('technician.by_category', category=cat, planner_id=p.id) }}">{{ t }}</a>
                    <form method="post" action="{{ url_for('main.remove_test_type', planner_id=p.id) }}" onsubmit="return confirm('Remove {{ t }} from this row?')" class="inline-form">
                      <input type="hidden" name="test_type" value="{{ t }}">
                      <input type="hidden" name="next" value="{{ request.full_path }}">
                      <button type="submit" class="remove-btn" title="Remove">Ã—</button>
                    </form>
                  </span>
                {% endfor %}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        {% if recent_planners|length == 0 %}
          <tr><td colspan="13" class="no-entries">No entries found.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Add Test Type Modal -->
  <div id="addTypeModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>

      </header>
      <form id="addTypeForm" method="post" action="/planner/add_test_type" class="modal-form">
        <input type="hidden" name="planner_id" id="addTypePlannerId">
        <input type="hidden" name="next" value="{{ request.full_path }}">
        <label>
          <span>Select type</span>
          <select name="test_type" id="addTypeSelect" required>
            <option value="">-- Choose --</option>
            <option>Vibration Analysis</option>
            <option>Oil Analysis</option>
            <option>Thermal Imaging</option>
            <option>Ultrasonic Analysis</option>
            <option>Motor Dynamic Analysis</option>
            <option>Ultrasonic Leak Detection</option>
            <option>Dynamic Balancing</option>
            <option>Other</option>
          </select>
        </label>
        <div class="actions">
          <button type="button" class="btn-ghost" onclick="closeAddTypeModal()">Cancel</button>
          <button type="submit" class="btn">Add</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('entriesFilterForm');
      ['filter_department','filter_equipment','filter_pm_date'].forEach(id => {
        const el = document.getElementById(id);
        if (el && form) {
          el.addEventListener('change', () => {
            if (form.requestSubmit) form.requestSubmit(); else form.submit();
          });
        }
      });
    });

    function openAddTypeModal(plannerId){
      const m = document.getElementById('addTypeModal');
      const pid = document.getElementById('addTypePlannerId');
      const sel = document.getElementById('addTypeSelect');
      if(!m||!pid||!sel) return;
      pid.value = plannerId;
      sel.value = '';
      m.style.display = 'flex';
      m.setAttribute('aria-hidden','false');
      sel.focus();
    }
    function closeAddTypeModal(){
      const m = document.getElementById('addTypeModal');
      if(!m) return;
      m.style.display = 'none';
      m.setAttribute('aria-hidden','true');
    }
    (function(){
      const m = document.getElementById('addTypeModal');
      if(!m) return;
      m.addEventListener('click', (e)=>{ if(e.target === m) closeAddTypeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeAddTypeModal(); });
    })();
  </script>

{% endblock %}
