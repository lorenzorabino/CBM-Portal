{% extends 'base.html' %}

{% block title %}CBM Dashboard{% endblock %}

{% block content %}
            <!-- Current date / day / ISO week indicator will be shown inline in the KPI toolbar -->

            <!-- KPI Filter + Cards -->
            <div class="kpi-toolbar-row" style="align-items:center; justify-content: space-between; margin-top:6px; gap:12px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <div class="segmented" role="tablist" aria-label="KPI scope">
                        <button class="seg-item {{ 'is-active' if (scope or 'weekly') == 'weekly' else '' }}" role="tab" aria-selected="{{ 'true' if (scope or 'weekly') == 'weekly' else 'false' }}" data-scope="weekly">This Week</button>
                        <button class="seg-item {{ 'is-active' if (scope or '') == 'pm_week' else '' }}" role="tab" aria-selected="{{ 'true' if (scope or '') == 'pm_week' else 'false' }}" data-scope="pm_week">PM Week</button>
                        <button class="seg-item {{ 'is-active' if (scope or '') == 'month' else '' }}" role="tab" aria-selected="{{ 'true' if (scope or '') == 'month' else 'false' }}" data-scope="month">Month</button>
                        <button class="seg-item {{ 'is-active' if (scope or '') in ['all','all-time','alltime','overall','total'] else '' }}" role="tab" aria-selected="{{ 'true' if (scope or '') in ['all','all-time','alltime','overall','total'] else 'false' }}" data-scope="all">All-time</button>
                    </div>
                    <label for="kpi-week-picker" style="font-size:.9rem; color:#003785; display:flex; gap:8px; align-items:center;">
                        <span style="font-size:.85rem; color:#003785;">Week</span>
                        <input id="kpi-week-picker" type="week" class="input" style="width:auto; min-width:140px;" value="{{ sel_year }}-W{{ '%02d' % sel_week }}" />
                    </label>
                    <label for="kpi-month-picker" style="font-size:.9rem; color:#003785; display:none; gap:8px; align-items:center;">
                        <span style="font-size:.85rem; color:#003785;">Month</span>
                        <input id="kpi-month-picker" type="month" class="input" style="width:auto; min-width:140px;" value="{{ '%04d-%02d'|format(sel_year, (sel_month or 1)) }}" />
                    </label>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
            <div class="kpi-scope-hint" aria-live="polite" style="font-size:.9rem; color:#003785;">PM Date:</div>
                    <div id="kpi-date-indicator" class="date-indicator" aria-live="polite" data-pm-date="{{ sel_pm_date or '' }}" data-pm-week="{{ pm_sel_week or '' }}" data-pm-year="{{ pm_sel_year or '' }}">
                        <div class="date-left">
                <div id="date-indicator-date" class="date-indicator-date">{{ sel_pm_date or '—' }}</div>
                            <div id="date-indicator-day" class="date-indicator-day">{{ sel_pm_day or '—' }}</div>
                        </div>
                        <div class="date-right">
                            <div class="date-week-label">Week</div>
                            <div id="date-indicator-week" class="date-indicator-week">{{ sel_week and ('W%02d %d'|format(sel_week, sel_year)) or 'W--' }}</div>
                        </div>
                        <!-- PM week indicator (server-provided) -->
                        <div id="pm-week-indicator" style="font-size:.85rem; color:#4b5563; margin-top:4px;">
                        </div>
                    </div>
                </div>
            </div>

            <section id="kpi-cards" data-scope="{{ scope or 'weekly' }}" data-week="{{ sel_week }}" data-year="{{ sel_year }}" data-month="{{ sel_month or '' }}" style="margin-top:12px;">
                {% set k = kpi_counts %}
                <div class="panel kpi-card kpi-total js-kpi" data-kpi="total" title="View details">
                    <div class="card-title">Total</div>
                    <div class="card-count">{{ k.total }}</div>
                    <div class="kpi-subchips">
                        <span class="kpi-chip chip-planned" data-label="Planned"><i class="kpi-dot"></i> Planned {{ k.planned_tests }}</span>
                        <span class="kpi-chip chip-unplanned" data-label="Unplanned"><i class="kpi-dot"></i> Unplanned {{ k.unplanned_tests }}</span>
                        <span class="kpi-chip chip-validation {{ 'show-inline' if (k.validation_tests or 0) > 0 else 'hidden' }}" data-label="Validation"><i class="kpi-dot"></i> Validation {{ k.validation_tests }}</span>
                        <span class="kpi-chip chip-other {{ 'show-inline' if (k.other_schedule_tests|default(0, true)) > 0 else 'hidden' }}" data-label="Other"><i class="kpi-dot"></i> Other {{ k.other_schedule_tests }}</span>
                    </div>
                </div>
                <div class="panel kpi-card kpi-completed js-kpi" data-kpi="completed" title="View details"><div class="card-title">Completed</div><div class="card-count">{{ k.completed }}</div></div>
                <div class="panel kpi-card kpi-inprogress js-kpi" data-kpi="in_progress" title="View details">
                    <div class="card-title">In Progress</div>
                    <div class="card-count">{{ k.active_in_progress }}</div>
                    <div class="kpi-subchips" style="font-size:.9rem;">
                        <span class="kpi-chip chip-ongoing"><i class="kpi-dot"></i> Ongoing {{ k.ongoing }}</span>
                        <span class="kpi-chip chip-analysis"><i class="kpi-dot"></i> Analysis {{ k.ongoing_analysis }}</span>
                        <span class="kpi-chip chip-sending"><i class="kpi-dot"></i> Sending {{ k.sending_report }}</span>
                    </div>
                </div>
                <div class="panel kpi-card kpi-revisit js-kpi" data-kpi="for_revisit" title="View details"><div class="card-title">For Revisit</div><div class="card-count">{{ k.for_revisit }}</div></div>
                <div class="panel kpi-card kpi-waived js-kpi" data-kpi="waived" title="View details"><div class="card-title">Waived</div><div class="card-count">{{ k.waived }}</div></div>
                <div class="panel kpi-card kpi-alarms js-kpi" data-kpi="alarms" title="View details">
                    <div class="card-title">Alarms</div>
                    <div class="card-count">{{ k.alarm_crit_warn }}</div>
                    <div class="kpi-subchips" style="font-size:.9rem;">
                        <span class="kpi-chip chip-critical"><i class="kpi-dot"></i> Critical {{ k.alarm_critical }}</span>
                        <span class="kpi-chip chip-warning"><i class="kpi-dot"></i> Warning {{ k.alarm_warning }}</span>
                    </div>
                </div>
            </section>

            <!-- Queues -->
            <section style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; margin-bottom:12px;">
                <div class="panel full-span">
                    <div class="panel-title">12-Week Trend</div>
                    <div class="chart-box trend-box">
                        <canvas id="trend12w" class="chart-full"></canvas>
                    </div>
                </div>
                <!-- Warnings & Criticals panel moved to Validation Results page -->
                <!-- Removed panels: Alarm Split (This Week), Missing Done Tested Date, Critical/Warning, Warning — Longest Not Corrected -->
            </section>

            <!-- Monday-style Board (equipment cards view) -->
            <section class="panel">
                <div class="panel-title">This Week's Board</div>
                <div style="margin-top:8px;">
                                        <div id="equipment-board-wrap">
                                            <div class="equipment-grid" aria-live="polite">
                        {% if equipment_board and equipment_board|length > 0 %}
                            {% for e in equipment_board %}
                                {% set pct = ((e.completed_count or 0) * 100 // (e.total_tests or 1)) %}
                                <article class="equipment-card" role="group" aria-label="Equipment {{ e.equipment }}">
                                    <div class="eq-head">
                                        <div class="eq-title">{{ e.equipment or ('#' ~ e.id) }}</div>
                                        <div class="eq-meta">{{ e.department or '' }}{% if e.pm_date %} • PM: {{ e.pm_date }}{% endif %}</div>
                                    </div>
                                    <div class="eq-body">
                                        <!-- Progress bar and count removed as requested -->
                                    </div>
                                    <div class="eq-actions">
                                        <a class="btn-secondary" href="{{ url_for('main.equipment_v3') }}?eqid={{ e.id }}">Open</a>
                                    </div>
                                </article>
                            {% endfor %}
                        {% endif %}
                                            </div>
                                        </div>
                    <!-- Progress legend -->
                    <div class="progress-legend" aria-label="Progress legend" style="display:flex; align-items:center; gap:8px; font-size:.9rem; color:#4b5563; margin-top:8px; flex-wrap:wrap;">
                        <span style="font-weight:600; color:#374151;">Legend:</span>
                        <span class="test-chip is-done" title="All required tests completed">
                            <i class="dot"></i>
                            <span class="name">Done</span>
                        </span>
                        <span class="test-chip is-pending" title="Some or all tests pending">
                            <i class="dot"></i>
                            <span class="name">Pending</span>
                        </span>
                    </div>

                    <!-- Keep original table for compatibility/fallback -->
                    <div style="overflow:auto; margin-top:12px;">
                        <table class="planner-table no-wrap" style="min-width:980px;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Department</th>
                                    <th>Equipment</th>
                                    <th>PM Date</th>
                                    <th>Schedule</th>
                                    <th>Progress</th>
                                    <th>Worst Alarm</th>
                                    <th>Open</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in board_rows %}
                                {% set pct = ( (r.completed_count or 0) * 100 // (r.total_tests or 1) ) %}
                                <tr>
                                    <td>#{{ r.id }}</td>
                                    <td>{{ r.department }}</td>
                                    <td>{{ r.equipment }}</td>
                                    <td>{{ r.pm_date or '-' }}</td>
                                    <td>
                                        {% set sc = (r.schedule_type or '')|lower %}
                                        <span class="{{ 'schedule-planned' if sc=='planned' else ('schedule-unplanned' if sc=='unplanned' else ('schedule-validation' if sc=='validation' else '')) }}">{{ r.schedule_type or '-' }}</span>
                                    </td>
                                    <td>
                                        {% if r.tests_breakdown and r.tests_breakdown|length > 0 %}
                                        <div class="test-chips" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">
                                            {% for t in r.tests_breakdown %}
                                                <span class="test-chip {{ 'is-done' if t.done else 'is-pending' }}" title="{{ t.name }}: {{ t.done_count }}/{{ t.total }} done">
                                                    <i class="dot"></i>
                                                    <span class="name">{{ t.name }}</span>
                                                    <span class="counts">{{ t.done_count }}/{{ t.total }}</span>
                                                </span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if r.worst_alarm %}
                                            <span class="badge {{ 'alarm-critical' if r.worst_alarm=='Critical' else ('alarm-warning' if r.worst_alarm=='Warning' else 'alarm-normal') }}">{{ r.worst_alarm }}</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td><a class="btn-secondary" href="{{ url_for('main.planner_tasks', planner_id=r.id) }}">View</a></td>
                                </tr>
                                {% else %}
                                <tr><td colspan="8" style="text-align:center; color:#666;">No rows</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
{% endblock %}
