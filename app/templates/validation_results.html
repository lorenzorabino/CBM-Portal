{% extends 'base.html' %}

{% block title %}Validation Results • CBM Portal{% endblock %}

{% block extra_head %}
  <style>
    /* Page-specific container overrides */
    .validation-container {
      max-width: none !important;        /* allow full-width */
      margin-left: 0 !important;         /* remove side margins */
      margin-right: 0 !important;
      padding: 5px !important;          /* 10px padding on all sides */
    }

    /* Layout helpers */
    .panel-flex { display: flex; flex-wrap: wrap; gap: 10px; }
    .filter-form-inline { display: flex; align-items: center; gap: 10px; }
  .kpi-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: stretch; }
  /* KPI cards: compact, consistent widths and stretch to equal height */
  .kpi-card { flex: 0 1 220px; min-width: 200px; display: flex; flex-direction: column; justify-content: space-between; }
  .kpi-left { display:flex; gap:12px; align-items:stretch; flex:1 1 560px; }

    /* Modal accessibility */
    .modal[hidden] { display: none; }
    .modal[aria-hidden="false"] { display: flex; }

    /* Chart container */
    .chart-container { width: 100%; max-width: 800px; margin: 0 auto; }
  </style>
{% endblock %}

{% block content %}
  <header class="page-header">
  <h1>Validation Results</h1>
  <div class="action-right">
    <a href="{{ url_for('main.planner_entries') }}" class="btn-secondary">Back to Planner Entries</a>
  </div>
  </header>

  <section class="planner-container validation-container">
    
  <form id="validationFilterForm" class="auto-filter-form" method="GET" action="{{ url_for('main.validation_results_alias') }}" style="display:flex; align-items:center; gap:8px; flex-wrap: wrap;">
      <label>Testing Type:</label>
      <select name="test_type" style="height:32px; width:220px;">
        <option value="">All</option>
        {% set types = (groups['Critical'] + groups['Warning'] + groups['Normal'] + groups['Unknown']) | map(attribute='Test_Type') | list %}
        {% for t in types | unique %}
          {% if t %}
          <option value="{{ t }}" {% if filters.test_type==t %}selected{% endif %}>{{ t }}</option>
          {% endif %}
        {% endfor %}
      </select>

      <label>Equipment:</label>
      <select name="equipment" style="height:32px; width:180px;">
        <option value="">All</option>
        {% for e in equipment_list_filter %}
          <option value="{{ e }}" {% if filters.equipment==e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>

  <button class="btn" type="submit">Apply</button>
  <a class="btn-secondary" href="{{ url_for('main.validation_results_alias') }}" style="text-decoration:none; padding:6px 10px;">Reset</a>
    </form>

  <!-- KPI cards row -->
  <section id="kpi-cards" style="margin-top:12px;">
      <div class="kpi-row">
        <!-- Left box: Top 5 longest (Warnings & Validation Not Corrected) -->
        <div class="kpi-left">
          <div class="panel" style="min-width:300px;">
            <div class="panel-title">Top Longest Open</div>
            <div style="padding:8px 6px; font-size:14px;">
              <div style="display:flex; flex-direction:column; gap:12px;">
                <div>
                  <div style="font-weight:700; margin-bottom:6px;">Warnings (top 5)</div>
                  {% if longest_warnings and longest_warnings|length > 0 %}
                    <table class="planner-table" style="width:100%; font-size:13px;">
                      <thead>
                        <tr><th>Equipment</th><th>Type</th><th>Days Open</th><th>Since</th></tr>
                      </thead>
                      <tbody>
                        {% for it in longest_warnings %}
                          <tr>
                            <td>{{ it.equipment or '-' }}</td>
                            <td>{{ it.test_type or '' }}</td>
                            <td>{{ it.days_open }}</td>
                            <td>{{ it.base_date }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <div style="color:#666;">No open warnings found.</div>
                  {% endif %}
                </div>

                <div>
                  <div style="font-weight:700; margin-bottom:6px;">Validation — Not Corrected (top 5)</div>
                  {% if longest_validation_not_corrected and longest_validation_not_corrected|length > 0 %}
                    <table class="planner-table" style="width:100%; font-size:13px;">
                      <thead>
                        <tr><th>Equipment</th><th>Type</th><th>Days Open</th><th>Since</th></tr>
                      </thead>
                      <tbody>
                        {% for it in longest_validation_not_corrected %}
                          <tr>
                            <td>{{ it.equipment or '-' }}</td>
                            <td>{{ it.test_type or '' }}</td>
                            <td>{{ it.days_open }}</td>
                            <td>{{ it.base_date }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% else %}
                    <div style="color:#666;">No long-open validation items.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Total -->
          <div class="panel kpi-card kpi-total">
            <div class="card-title">Validation Total</div>
            <div class="card-count">{{ validation_count }}</div>
            <div class="kpi-subchips" aria-label="Breakdown">
              <span class="kpi-chip chip-validation"><i class="kpi-dot"></i> Corrected {{ validation_corrected|length if validation_corrected else 0 }}</span>
              <span class="kpi-chip chip-warning"><i class="kpi-dot"></i> Not Corrected {{ validation_not_corrected|length if validation_not_corrected else 0 }}</span>
            </div>
          </div>
        </div>

        <!-- Corrected -->
        <a href="#section-validation-corrected" style="text-decoration:none;">
          <div class="panel kpi-card kpi-completed" style="cursor:pointer;">
            <div class="card-title">Corrected</div>
            <div class="card-count">{{ validation_corrected|length if validation_corrected else 0 }}</div>
            <div class="kpi-subchips"><span class="kpi-chip chip-validation"><i class="kpi-dot"></i> {{ validation_corrected_pct }}%</span></div>
          </div>
        </a>

        <!-- Not Corrected -->
        <a href="#section-validation-not-corrected" style="text-decoration:none;">
          <div class="panel kpi-card kpi-alarms" style="cursor:pointer;">
            <div class="card-title">Not Corrected</div>
            <div class="card-count">{{ validation_not_corrected|length if validation_not_corrected else 0 }}</div>
            <div class="kpi-subchips"><span class="kpi-chip chip-warning"><i class="kpi-dot"></i> {{ validation_not_corrected_pct }}%</span></div>
          </div>
        </a>

  <!-- Removed Longest Not Corrected KPI card -->
      </div>
    </section>

    <section class="panel full-span" style="margin-top:12px;">
      <div class="panel-title" style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
        <span>Alarms — Open vs Closed (12 Weeks)</span>
        <label style="font-weight:normal; font-size:.9rem; color:#475569; display:flex; align-items:center; gap:6px;">
          <span>Corrected basis:</span>
          <select id="basisToggle" class="input" style="padding:4px 8px;">
            <option value="planner">Planner week</option>
            <option value="done">Done week</option>
          </select>
        </label>
      </div>
      <div class="chart-box">
        <canvas id="warnCorrectedStack" class="chart-full" aria-label="Warnings & Criticals Open vs Closed (12 Weeks)"></canvas>
      </div>
    </section>

    <!-- Validation / groups tables -->
    <section class="panel" style="margin-top:12px;">
        <div class="panel-title">Validation <span class="badge" style="margin-left:8px;">{{ validation_count }}</span></div>
        {% set vitems = validation_items %}
        {% if not vitems or vitems|length == 0 %}
          <p style="color:#666;">No records.</p>
        {% else %}
        <div class="double-scroll-wrapper">
          <div class="double-scroll-top"><div style="width:1600px"></div></div>
          <div class="double-scroll-content">
            <table class="planner-table no-wrap">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Week</th>
                  <th>Year</th>
                  <th>Department</th>
                  <th>Equipment</th>
                  <th>Type</th>
                  <th>Schedule</th>
                  <th>Status</th>
                  <th>Alarm</th>
                  <th>Proposed Target Date</th>
                  <th>Done Date</th>
                  <th>Open</th>
                </tr>
              </thead>
              <tbody>
                {% for r in vitems %}
                  {% set sc = (r.schedule_type or '')|lower %}
                  {% set s = (r.Status or '') %}
                  {% set alarm = (r.Alarm_Level or '')|lower %}
                  <tr>
                    <td>
                      {% if r.planner_id %}
                        <a href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">{{ r.planner_id }}</a>
                      {% else %}-{% endif %}
                    </td>
                    <td>{{ r.week_number or '' }}</td>
                    <td>{{ r.year or '' }}</td>
                    <td>{{ r.department or '-' }}</td>
                    <td>{{ r.equipment or '-' }}</td>
                    <td>{{ r.Test_Type or '-' }}</td>
                    <td>
                      {% if r.schedule_type %}
                        <span class="{{ 'schedule-planned' if sc=='planned' else ('schedule-unplanned' if sc=='unplanned' else ('schedule-validation' if sc=='validation' else '')) }}">{{ r.schedule_type }}</span>
                      {% else %}-{% endif %}
                    </td>
                    <td>
                      <span class="{{ 'status-completed' if s|lower in ['completed','done'] else ('status-ongoing' if s|lower in ['ongoing','todo',''] else '') }}">{{ s or 'Ongoing' }}</span>
                    </td>
                    <td>
                      {% if alarm=='critical' %}
                        <span class="badge alarm-critical">Critical</span>
                      {% elif alarm=='warning' %}
                        <span class="badge alarm-warning">Warning</span>
                      {% elif alarm=='normal' %}
                        <span class="badge">Normal</span>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                      <td>{{ (r.proposed_target_date or '')[:10] }}</td>
                    <td>{{ (r.Done_Tested_Date or '')[:10] }}</td>
                    <td>
                      {% if r.planner_id %}
                        <a class="btn-secondary validation-open" data-planner-id="{{ r.planner_id }}" href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">Open</a>
                      {% else %}
                        <span class="btn-secondary" style="opacity:.6; pointer-events:none;">Open</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
      </section>

    <section class="panel" style="margin-top:12px;">
      <div class="panel-title">Critical <span class="badge" style="margin-left:8px;">{{ summary['Critical'] }}</span></div>
      {% set items = groups['Critical'] %}
      {% if not items or items|length == 0 %}
        <p style="color:#666;">No records.</p>
      {% else %}
      <div class="double-scroll-wrapper">
        <div class="double-scroll-top"><div style="width:1600px"></div></div>
        <div class="double-scroll-content">
          <table class="planner-table no-wrap">
            <thead>
              <tr>
                <th>ID</th>
                <th>Week</th>
                <th>Year</th>
                <th>Department</th>
                <th>Equipment</th>
                <th>Type</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Alarm</th>
                <th>Done Date</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody>
              {% for r in items %}
                {% set sc = (r.schedule_type or '')|lower %}
                {% set s = (r.Status or '') %}
                {% if sc != 'validation' %}
                <tr>
                  <td>
                    {% if r.planner_id %}
                      <a href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">{{ r.planner_id }}</a>
                    {% else %}-{% endif %}
                  </td>
                  <td>{{ r.week_number or '' }}</td>
                  <td>{{ r.year or '' }}</td>
                  <td>{{ r.department or '-' }}</td>
                  <td>{{ r.equipment or '-' }}</td>
                  <td>{{ r.Test_Type or '-' }}</td>
                  <td>
                    {% if r.schedule_type %}
                      <span class="{{ 'schedule-planned' if sc=='planned' else ('schedule-unplanned' if sc=='unplanned' else ('schedule-validation' if sc=='validation' else '')) }}">{{ r.schedule_type }}</span>
                    {% else %}-{% endif %}
                  </td>
                  <td>
                    <span class="{{ 'status-completed' if s|lower in ['completed','done'] else ('status-ongoing' if s|lower in ['ongoing','todo',''] else '') }}">{{ s or 'Ongoing' }}</span>
                  </td>
                  <td><span class="badge alarm-critical">Critical</span></td>
                  <td>{{ (r.Done_Tested_Date or '')[:10] }}</td>
                  <td style="display:flex; gap:6px; align-items:center;">
                    {% if r.planner_id %}
                      <a class="btn-secondary" href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">Open</a>
                    {% else %}
                      <span class="btn-secondary" style="opacity:.6; pointer-events:none;">Open</span>
                    {% endif %}
                    <button class="btn open-validation-modal" type="button" data-testing-id="{{ r.Testing_ID }}" title="Move this to Validation">For Validation</button>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </section>

    <section class="panel" style="margin-top:12px;">
      <div class="panel-title">Warning <span class="badge" style="margin-left:8px;">{{ summary['Warning'] }}</span></div>
      {% set itemsW = groups['Warning'] %}
      {% if not itemsW or itemsW|length == 0 %}
        <p style="color:#666;">No records.</p>
      {% else %}
      <div class="double-scroll-wrapper">
        <div class="double-scroll-top"><div style="width:1600px"></div></div>
        <div class="double-scroll-content">
          <table class="planner-table no-wrap">
            <thead>
              <tr>
                <th>ID</th>
                <th>Week</th>
                <th>Year</th>
                <th>Department</th>
                <th>Equipment</th>
                <th>Type</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Alarm</th>
                <th>Done Date</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody>
              {% for r in itemsW %}
                {% set sc = (r.schedule_type or '')|lower %}
                {% set s = (r.Status or '') %}
                {% if sc != 'validation' %}
                <tr>
                  <td>
                    {% if r.planner_id %}
                      <a href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">{{ r.planner_id }}</a>
                    {% else %}-{% endif %}
                  </td>
                  <td>{{ r.week_number or '' }}</td>
                  <td>{{ r.year or '' }}</td>
                  <td>{{ r.department or '-' }}</td>
                  <td>{{ r.equipment or '-' }}</td>
                  <td>{{ r.Test_Type or '-' }}</td>
                  <td>
                    {% if r.schedule_type %}
                      <span class="{{ 'schedule-planned' if sc=='planned' else ('schedule-unplanned' if sc=='unplanned' else ('schedule-validation' if sc=='validation' else '')) }}">{{ r.schedule_type }}</span>
                    {% else %}-{% endif %}
                  </td>
                  <td>
                    <span class="{{ 'status-completed' if s|lower in ['completed','done'] else ('status-ongoing' if s|lower in ['ongoing','todo',''] else '') }}">{{ s or 'Ongoing' }}</span>
                  </td>
                  <td><span class="badge alarm-warning">Warning</span></td>
                  <td>{{ (r.Done_Tested_Date or '')[:10] }}</td>
                  <td style="display:flex; gap:6px; align-items:center;">
                    {% if r.planner_id %}
                      <a class="btn-secondary" href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">Open</a>
                    {% else %}
                      <span class="btn-secondary" style="opacity:.6; pointer-events:none;">Open</span>
                    {% endif %}
                    <button class="btn open-validation-modal" type="button" data-testing-id="{{ r.Testing_ID }}" title="Move this to Validation">For Validation</button>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </section>

  <section id="section-validation-not-corrected" class="panel" style="margin-top:12px;">
      <div class="panel-title">Validation - Not Corrected <span class="badge" style="margin-left:8px;">{{ validation_not_corrected_count }}</span></div>
      {% set vnc = validation_not_corrected %}
      {% if not vnc or vnc|length == 0 %}
        <p style="color:#666;">No records.</p>
      {% else %}
      <div class="double-scroll-wrapper">
        <div class="double-scroll-top"><div style="width:1600px"></div></div>
        <div class="double-scroll-content">
          <table class="planner-table no-wrap">
            <thead>
              <tr>
                <th>ID</th>
                <th>Week</th>
                <th>Year</th>
                <th>Department</th>
                <th>Equipment</th>
                <th>Type</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Alarm</th>
                <th>Done Date</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody>
              {% for r in vnc %}
                {% set sc = (r.schedule_type or '')|lower %}
                {% set s = (r.Status or '') %}
                {% set alarm = (r.Alarm_Level or '')|lower %}
                <tr>
                  <td>
                    {% if r.planner_id %}
                      <a href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">{{ r.planner_id }}</a>
                    {% else %}-{% endif %}
                  </td>
                  <td>{{ r.week_number or '' }}</td>
                  <td>{{ r.year or '' }}</td>
                  <td>{{ r.department or '-' }}</td>
                  <td>{{ r.equipment or '-' }}</td>
                  <td>{{ r.Test_Type or '-' }}</td>
                  <td>
                    {% if r.schedule_type %}
                      <span class="{{ 'schedule-planned' if sc=='planned' else ('schedule-unplanned' if sc=='unplanned' else ('schedule-validation' if sc=='validation' else '')) }}">{{ r.schedule_type }}</span>
                    {% else %}-{% endif %}
                  </td>
                  <td>
                    <span class="{{ 'status-completed' if s|lower in ['completed','done'] else ('status-ongoing' if s|lower in ['ongoing','todo',''] else '') }}">{{ s or 'Ongoing' }}</span>
                  </td>
                  <td>
                    {% if alarm=='critical' %}
                      <span class="badge alarm-critical">Critical</span>
                    {% elif alarm=='warning' %}
                      <span class="badge alarm-warning">Warning</span>
                    {% elif alarm=='normal' %}
                      <span class="badge">Normal</span>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>{{ (r.Done_Tested_Date or '')[:10] }}</td>
                  <td>
                    {% if r.planner_id %}
                      <a class="btn-secondary" href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">Open</a>
                    {% else %}
                      <span class="btn-secondary" style="opacity:.6; pointer-events:none;">Open</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </section>

  <section id="section-validation-corrected" class="panel" style="margin-top:12px;">
      <div class="panel-title">Validation - Corrected <span class="badge" style="margin-left:8px;">{{ validation_corrected_count }}</span></div>
      {% set vc = validation_corrected %}
      {% if not vc or vc|length == 0 %}
        <p style="color:#666;">No records.</p>
      {% else %}
      <div class="double-scroll-wrapper">
        <div class="double-scroll-top"><div style="width:1600px"></div></div>
        <div class="double-scroll-content">
          <table class="planner-table no-wrap">
            <thead>
              <tr>
                <th>ID</th>
                <th>Week</th>
                <th>Year</th>
                <th>Department</th>
                <th>Equipment</th>
                <th>Type</th>
                <th>Schedule</th>
                <th>Status</th>
                <th>Alarm</th>
                <th>Done Date</th>
                <th>Open</th>
              </tr>
            </thead>
            <tbody>
              {% for r in vc %}
                {% set sc = (r.schedule_type or '')|lower %}
                {% set s = (r.Status or '') %}
                {% set alarm = (r.Alarm_Level or '')|lower %}
                <tr>
                  <td>
                    {% if r.planner_id %}
                      <a href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">{{ r.planner_id }}</a>
                    {% else %}-{% endif %}
                  </td>
                  <td>{{ r.week_number or '' }}</td>
                  <td>{{ r.year or '' }}</td>
                  <td>{{ r.department or '-' }}</td>
                  <td>{{ r.equipment or '-' }}</td>
                  <td>{{ r.Test_Type or '-' }}</td>
                  <td>
                    {% if r.schedule_type %}
                      <span class="{{ 'schedule-planned' if sc=='planned' else ('schedule-unplanned' if sc=='unplanned' else ('schedule-validation' if sc=='validation' else '')) }}">{{ r.schedule_type }}</span>
                    {% else %}-{% endif %}
                  </td>
                  <td>
                    <span class="{{ 'status-completed' if s|lower in ['completed','done'] else ('status-ongoing' if s|lower in ['ongoing','todo',''] else '') }}">{{ s or 'Ongoing' }}</span>
                  </td>
                  <td>
                    {% if alarm=='critical' %}
                      <span class="badge alarm-critical">Critical</span>
                    {% elif alarm=='warning' %}
                      <span class="badge alarm-warning">Warning</span>
                    {% elif alarm=='normal' %}
                      <span class="badge">Normal</span>
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>{{ (r.Done_Tested_Date or '')[:10] }}</td>
                  <td>
                    {% if r.planner_id %}
                      <a class="btn-secondary" href="{{ url_for('main.planner_tasks', planner_id=r.planner_id) }}">Open</a>
                    {% else %}
                      <span class="btn-secondary" style="opacity:.6; pointer-events:none;">Open</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </section>

  </section>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const form = document.getElementById('validationFilterForm');
      if (!form) return;
      form.querySelectorAll('select').forEach(function(sel){
        sel.addEventListener('change', function(){ if (form.requestSubmit) form.requestSubmit(); else form.submit(); });
      });

      // Light entrance animation for KPI cards
      (function(){
        const cards = document.querySelectorAll('#kpi-cards .kpi-card');
        let d = 0;
        cards.forEach(c => { setTimeout(() => c.classList.add('is-in'), d); d += 70; });
      })();

    });

    // Sync double scroll widths and scroll positions dynamically
    (function(){
      function init(wrapper){
        const topScroller = wrapper.querySelector('.double-scroll-top');
        const topInner = topScroller && topScroller.firstElementChild;
        const content = wrapper.querySelector('.double-scroll-content');
        const table = content && content.querySelector('table');
        if (!topScroller || !topInner || !content) return;
        function syncWidth(){
          const w = (table && table.scrollWidth) || content.scrollWidth || content.clientWidth;
          topInner.style.width = w + 'px';
        }
        syncWidth();
        let raf;
        const onScrollTop = () => { if (raf) cancelAnimationFrame(raf); raf = requestAnimationFrame(() => { content.scrollLeft = topScroller.scrollLeft; }); };
        const onScrollContent = () => { if (raf) cancelAnimationFrame(raf); raf = requestAnimationFrame(() => { topScroller.scrollLeft = content.scrollLeft; }); };
        topScroller.addEventListener('scroll', onScrollTop);
        content.addEventListener('scroll', onScrollContent);
        window.addEventListener('resize', syncWidth);
        setTimeout(syncWidth, 50);
      }
      function initAll(){
        document.querySelectorAll('.double-scroll-wrapper').forEach(init);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAll);
      } else { initAll(); }
    })();

    // Disable interactive controls on validation page unless a Post-it has been posted from Notifications
    (function(){
      function isPostedForPlanner(plannerId){ try { return !!localStorage.getItem('notif_posted_planner_' + plannerId); } catch(e){ return false; } }
      function isPostedForTesting(testingId){ try { return !!localStorage.getItem('notif_posted_testing_' + testingId); } catch(e){ return false; } }
      function disableRowControls(){
        document.querySelectorAll('.double-scroll-content table tbody tr').forEach(function(tr){
          const link = tr.querySelector('a[href*="planner_tasks"]');
          let plannerId = null;
          if(link && link.textContent) plannerId = link.textContent.trim();
          const openBtn = tr.querySelector('.validation-open');
          if(openBtn && openBtn.dataset && openBtn.dataset.plannerId) plannerId = openBtn.dataset.plannerId;
          const allow = plannerId ? isPostedForPlanner(plannerId) : false;
          if(!allow){
            tr.querySelectorAll('a, button, input, select, textarea').forEach(function(el){
              el.setAttribute('aria-disabled','true');
              el.style.pointerEvents = 'none';
              el.style.opacity = '0.6';
            });
          }
        });
      }
      if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', disableRowControls); else disableRowControls();
    })();

    // Modal: Move to Validation with Proposed Target Date
    (function(){
      const modal = document.getElementById('validationModal');
      const modalCard = modal && modal.querySelector('.modal-card');
      const closeBtn = document.getElementById('validationModalClose');
      const cancelBtn = document.getElementById('validationModalCancel');
      const form = document.getElementById('validationModalForm');
      const testingIdInput = document.getElementById('validation_testing_id');
      const dateInput = document.getElementById('proposed_target_date');
      let previouslyFocused = null;

      function focusableElements(container){
        return Array.from(container.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'))
          .filter(el => el.offsetWidth > 0 || el.offsetHeight > 0 || el === document.activeElement);
      }

      function trapTab(e){
        if (e.key !== 'Tab') return;
        const elems = focusableElements(modalCard);
        if (!elems.length) { e.preventDefault(); return; }
        const first = elems[0];
        const last = elems[elems.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) { e.preventDefault(); last.focus(); }
        } else {
          if (document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      }

      function keyHandler(e){
        if (e.key === 'Escape') { e.preventDefault(); closeModal(); }
        else trapTab(e);
      }

      function openModal(testingId){
        previouslyFocused = document.activeElement;
        testingIdInput.value = testingId || '';
        try {
          if (!dateInput.value) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth()+1).padStart(2,'0');
            const dd = String(today.getDate()).padStart(2,'0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            dateInput.value = todayStr;
            dateInput.min = todayStr;
          }
        } catch(_) {}
        modal.setAttribute('aria-hidden','false');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        setTimeout(()=>{
          const elems = focusableElements(modalCard);
          (elems[0] || dateInput).focus();
        }, 10);
        document.addEventListener('keydown', keyHandler);
      }

      function closeModal(){
        modal.setAttribute('aria-hidden','true');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        document.removeEventListener('keydown', keyHandler);
        try { if (previouslyFocused && previouslyFocused.focus) previouslyFocused.focus(); } catch(_){ }
      }

      document.addEventListener('click', function(e){
        const el = e.target.closest('.open-validation-modal');
        if(el){
          const tid = el.getAttribute('data-testing-id');
          openModal(tid);
        }
      });

      [closeBtn, cancelBtn].forEach(el => el && el.addEventListener('click', closeModal));
      if(modal) modal.addEventListener('click', function(e){ if (e.target === modal) closeModal(); });
    })();
  </script>
  
  <!-- Modal markup placed here to keep DOM in document flow -->
  <div id="validationModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); align-items:center; justify-content:center; z-index:1000;">
    <div class="modal-card" role="document" aria-labelledby="validationModalTitle" style="background:#fff; width:min(480px, 92vw); border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden;">
      <div style="padding:12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
        <div id="validationModalTitle" style="font-weight:600;">Move to Validation</div>
        <button type="button" id="validationModalClose" aria-label="Close dialog" style="border:none; background:transparent; font-size:20px; line-height:1; cursor:pointer;">×</button>
      </div>
      <form id="validationModalForm" method="post" action="{{ url_for('main.move_to_validation') }}" style="padding:16px; display:flex; flex-direction:column; gap:12px;">
        <div>
          <label for="proposed_target_date" style="display:block; margin-bottom:6px;">Proposed Target Date</label>
          <input id="proposed_target_date" name="proposed_target_date" type="date" required style="height:34px; padding:4px 8px; width: 220px;" />
        </div>
        <input type="hidden" name="testing_id" id="validation_testing_id" value="" />
        <input type="hidden" name="next" value="{{ request.full_path }}" />
        {% if csrf_token is defined %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        {% endif %}
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button type="button" class="btn-secondary" id="validationModalCancel">Cancel</button>
          <button type="submit" class="btn">Move</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}


