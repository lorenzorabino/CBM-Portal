<title>CBM â€¢ Manual Scheduling</title>
{% extends 'technician/_planner_base.html' %}
{% block planner_content %}
<main class="planner-container">
    <form method="POST" action="/planner" class="planner-form" id="plannerForm">
        <div class="form-group">
            <label for="week_number">Week Number:</label>
            <input type="number" id="week_number" name="week_number" min="1" max="52" required value="{{ default_week if default_week is not none else '' }}">
            <label for="year">Year:</label>
            <input type="number" id="year" name="year" required value="{{ default_year if default_year is not none else '' }}">
        </div>

        <table id="plannerTable" class="planner-table">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Equipment</th>
                    <th>Input Date</th>
                    <th>Day</th>
                    <th>Testing Type</th>
                    <th>PM Date</th>
                    <th>PM Week</th>
                    <th>Schedule Type</th>
                    <th>Proposed Target Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- hidden template row -->
                <tr id="templateRow" style="display:none;">
                    <td>
                        <select name="department_template" id="department_template" onchange="onDepartmentChange(this, 'equipment_template', 'equipment_new_template')" required disabled>
                            <option value="">Select Department</option>
                            {% for dept in department_list %}
                                <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                            <option value="Add New">Add New</option>
                        </select>
                        <input type="text" name="department_new_template" id="department_new_template" placeholder="Enter new department" class="hidden-input" disabled>
                    </td>
                    <td>
                        <select name="equipment_template" id="equipment_template" onchange="onEquipmentChange(this, 'equipment_new_template')" required disabled>
                            <option value="">Select Equipment</option>
                        </select>
                        <input type="text" name="equipment_new_template" id="equipment_new_template" placeholder="Enter new equipment" class="hidden-input" disabled>
                    </td>
                    <td><input type="date" name="date_template" id="date_template" required onchange="updateDay(this)" disabled></td>
                    <td><input type="text" name="day_template" id="day_template" placeholder="Day" readonly disabled></td>
                    <td>
                        <div class="testing-grid">
                            <label><input type="checkbox" name="testing_template" value="Vibration Analysis" disabled> <span class="tag va">Vibration Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Oil Analysis" disabled> <span class="tag oil">Oil Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Thermal Imaging" disabled> <span class="tag thermal">Thermal Imaging</span></label>
                            <label><input type="checkbox" name="testing_template" value="Ultrasonic Analysis" disabled> <span class="tag ultra">Ultrasonic Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Motor Dynamic Analysis" disabled> <span class="tag mda">Motor Dynamic Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Ultrasonic Leak Detection" disabled> <span class="tag leak">Ultrasonic Leak Detection</span></label>
                            <label><input type="checkbox" name="testing_template" value="Dynamic Balancing" disabled> <span class="tag balance">Dynamic Balancing</span></label>
                            <label><input type="checkbox" name="testing_template" value="Other" disabled> <span class="tag other">Other</span></label>
                        </div>
                    </td>
                    <td><input type="date" name="pm_date_template" id="pm_date_template" required disabled></td>
                    <td><input type="number" name="pm_week_template" id="pm_week_template" readonly disabled></td>
                    <td>
                        <select name="schedule_type_template" id="schedule_type_template" required disabled onchange="updateScheduleColor(this)">
                            <option value="">Select</option>
                            <option value="Planned" selected>Planned</option>
                            <option value="Unplanned">Unplanned</option>
                            <option value="Validation">Validation</option>
                        </select>
                    </td>
                    <td><input type="date" name="proposed_target_date_template" id="proposed_target_date_template" required disabled></td>
                </tr>

                <!-- first live row -->
                <tr>
                    <td>
                        <select name="department_0" id="department_0" onchange="onDepartmentChange(this, 'equipment_0', 'equipment_new_0')" required>
                            <option value="">Select Department</option>
                            {% for dept in department_list %}
                                <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                            <option value="Add New">Add New</option>
                        </select>
                        <input type="text" name="department_new_0" id="department_new_0" placeholder="Enter new department" class="hidden-input">
                    </td>
                    <td>
                        <select name="equipment_0" id="equipment_0" onchange="onEquipmentChange(this, 'equipment_new_0')" required>
                            <option value="">Select Equipment</option>
                        </select>
                        <input type="text" name="equipment_new_0" id="equipment_new_0" placeholder="Enter new equipment" class="hidden-input">
                    </td>
                    <td><input type="date" name="date_0" id="date_0" required onchange="updateDay(this)" readonly tabindex="-1" aria-readonly="true" style="pointer-events:none; background:#f7f7f7;" value="{{ default_date if default_date is not none else '' }}"></td>
                    <td><input type="text" name="day_0" id="day_0" placeholder="Day" readonly tabindex="-1" aria-readonly="true" style="pointer-events:none; background:#f7f7f7;" value="{{ default_day if default_day is not none else '' }}"></td>
                    <td>
                        <div class="testing-grid">
                            <label><input type="checkbox" name="testing_0" value="Vibration Analysis"> <span class="tag va">Vibration Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Oil Analysis"> <span class="tag oil">Oil Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Thermal Imaging"> <span class="tag thermal">Thermal Imaging</span></label>
                            <label><input type="checkbox" name="testing_0" value="Ultrasonic Analysis"> <span class="tag ultra">Ultrasonic Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Motor Dynamic Analysis"> <span class="tag mda">Motor Dynamic Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Ultrasonic Leak Detection"> <span class="tag leak">Ultrasonic Leak Detection</span></label>
                            <label><input type="checkbox" name="testing_0" value="Dynamic Balancing"> <span class="tag balance">Dynamic Balancing</span></label>
                            <label><input type="checkbox" name="testing_0" value="Other"> <span class="tag other">Other</span></label>
                        </div>
                    </td>
                    <td><input type="date" name="pm_date_0" id="pm_date_0" required></td>
                    <td><input type="number" name="pm_week_0" id="pm_week_0" readonly tabindex="-1" aria-readonly="true" style="pointer-events:none; background:#f7f7f7;"></td>
                    <td>
                        <select name="schedule_type_0" id="schedule_type_0" required onchange="updateScheduleColor(this)">
                            <option value="">Select</option>
                            <option value="Planned" selected>Planned</option>
                            <option value="Unplanned">Unplanned</option>
                            <option value="Validation">Validation</option>
                        </select>
                    </td>
                    <td><input type="date" name="proposed_target_date_0" id="proposed_target_date_0" required></td>
                </tr>
            </tbody>
        </table>

        <div class="form-actions">
            <label><input type="checkbox" id="done_checkbox"> Done</label>
            <button type="submit" class="btn-primary">Submit</button>
        </div>
    </form>
</main>

<!-- Duplicate warning modal -->
<div id="dupModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:1000;">
    <div class="modal-content" style="background:#fff; padding:16px; border-radius:8px; width:min(640px, 92vw); box-shadow:0 10px 24px rgba(0,0,0,0.2);">
        <h3 style="margin-top:0;">Possible duplicate planner entry</h3>
        <div id="dupBody" style="max-height:50vh; overflow:auto; font-size:0.95rem; line-height:1.4;"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button type="button" class="btn-secondary" id="dupDismiss">Dismiss</button>
        </div>
    </div>
    </div>

{# Planner Entries table removed per request #}

<script id="deptEquipData" type="application/json">{{ department_equipment_map | tojson | safe }}</script>
<script>
    // Return today's date in local timezone as YYYY-MM-DD (no UTC shift)
    function todayLocalStr() {
        const d = new Date();
        // Normalize to local date by removing timezone offset
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 10);
    }

    // Populate Day field from Date input and optionally set week/year.
    function getISOWeek(d) {
        // d: Date object
        const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        // ISO week starts on Monday. getUTCDay: 0 (Sun) - 6 (Sat); convert 0->7
        const dayNum = date.getUTCDay() || 7;
        // Set to Thursday in current week: date + 4 - dayNum
        date.setUTCDate(date.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
        const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
        return weekNo;
    }

    function updateDay(dateInput) {
        try {
            if (!dateInput) return;
            const id = dateInput.id; // e.g., date_0 or date_template
            const dayId = id.replace('date', 'day');
            const dayInput = document.getElementById(dayId);
            const val = dateInput.value;
            if (!dayInput) return;
            if (!val) { dayInput.value = ''; return; }
            // Use local Date parsing for YYYY-MM-DD
            const dt = new Date(val + 'T00:00:00');
            const names = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            dayInput.value = names[dt.getDay()];

            // If main week/year inputs exist and are empty, auto-fill them from this date
            const weekInput = document.getElementById('week_number');
            const yearInput = document.getElementById('year');
            if (weekInput && yearInput) {
                try {
                    const isoWeek = getISOWeek(dt);
                    weekInput.value = isoWeek;
                    yearInput.value = dt.getFullYear();
                } catch(e) {
                    // swallow
                }
            }
        } catch(e) {
            console.error('updateDay error', e);
        }
    }

    // Cascade equipment options when a Department is selected and toggle "Add New" inputs.
    const deptEquipMap = (function(){
        try {
            const el = document.getElementById('deptEquipData');
            return el ? JSON.parse(el.textContent || '{}') : {};
        } catch(e) { console.error('Failed to parse deptEquipData', e); return {}; }
    })();

    function populateEquipmentOptions(equipmentSelect, dept) {
        if (!equipmentSelect) return;
        // clear existing
        equipmentSelect.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select Equipment';
        equipmentSelect.appendChild(defaultOpt);

        if (!dept) return;
        const list = deptEquipMap[dept] || [];
        list.forEach(eq => {
            const opt = document.createElement('option');
            opt.value = eq;
            opt.textContent = eq;
            equipmentSelect.appendChild(opt);
        });
        const addOpt = document.createElement('option');
        addOpt.value = 'Add New';
        addOpt.textContent = 'Add New';
        equipmentSelect.appendChild(addOpt);
    }

    function onDepartmentChange(deptSelect, equipmentId, equipmentNewId) {
        try {
            const deptVal = deptSelect.value;
            const equipmentSelect = document.getElementById(equipmentId);
            const equipmentNewInput = document.getElementById(equipmentNewId);
            // Toggle department new input (id pattern: department_new_X)
            const deptNewId = deptSelect.id.replace('department', 'department_new');
            const deptNewInput = document.getElementById(deptNewId);

            if (deptVal === 'Add New') {
                if (deptNewInput) { deptNewInput.disabled = false; deptNewInput.classList.remove('hidden-input'); }
                // clear equipment options and allow adding new equipment
                if (equipmentSelect) { equipmentSelect.innerHTML = ''; const o = document.createElement('option'); o.value='Add New'; o.textContent='Add New'; equipmentSelect.appendChild(o); equipmentSelect.value = 'Add New'; }
                if (equipmentNewInput) { equipmentNewInput.disabled = false; equipmentNewInput.classList.remove('hidden-input'); }
            } else {
                if (deptNewInput) { deptNewInput.disabled = true; deptNewInput.classList.add('hidden-input'); deptNewInput.value = ''; }
                populateEquipmentOptions(equipmentSelect, deptVal);
                if (equipmentNewInput) { equipmentNewInput.disabled = true; equipmentNewInput.classList.add('hidden-input'); equipmentNewInput.value = ''; }
            }
        } catch (e) {
            console.error('onDepartmentChange error', e);
        }
    }

    function onEquipmentChange(equipmentSelect, equipmentNewId) {
        try {
            const eqVal = equipmentSelect.value;
            const eqNewInput = document.getElementById(equipmentNewId);
            if (eqVal === 'Add New') {
                if (eqNewInput) { eqNewInput.disabled = false; eqNewInput.classList.remove('hidden-input'); }
            } else {
                if (eqNewInput) { eqNewInput.disabled = true; eqNewInput.classList.add('hidden-input'); eqNewInput.value = ''; }
            }
        } catch (e) {
            console.error('onEquipmentChange error', e);
        }
    }

    // --- Dynamic rows: auto-add and done cleanup ---
    function getMaxIndex() {
        let max = -1;
        document.querySelectorAll('select[id^="department_"], input[id^="date_"]').forEach(el => {
            const m = el.id.match(/_(\d+)$/);
            if (m) max = Math.max(max, parseInt(m[1], 10));
        });
        return max;
    }

    function rowSelectors(i) {
        return {
            dept: document.getElementById('department_' + i),
            deptNew: document.getElementById('department_new_' + i),
            equip: document.getElementById('equipment_' + i),
            equipNew: document.getElementById('equipment_new_' + i),
            date: document.getElementById('date_' + i),
            day: document.getElementById('day_' + i),
            pm: document.getElementById('pm_date_' + i),
            pmWeek: document.getElementById('pm_week_' + i),
            sched: document.getElementById('schedule_type_' + i),
            target: document.getElementById('proposed_target_date_' + i),
            tests: Array.from(document.querySelectorAll('input[name="testing_' + i + '"]')),
        };
    }

    function isRowFilled(i) {
        const r = rowSelectors(i);
        if (!r.dept || !r.equip || !r.date || !r.pm || !r.sched || !r.target) return false;
        // Consider "filled" when required fields have a value and at least one test type checked
        const requiredOk = !!(r.dept.value && (r.equip.value || (r.equip.value==='Add New' && r.equipNew && r.equipNew.value)) && r.date.value && r.pm.value && r.sched.value && r.target.value);
        const anyTest = r.tests.some(cb => cb.checked);
        return requiredOk && anyTest;
    }

    function isRowEmpty(i) {
        const r = rowSelectors(i);
        if (!r.dept && !r.equip && !r.pm && !r.target && (!r.tests || r.tests.length === 0)) return true;
        // Consider a row empty if user hasn't selected dept/equipment, hasn't set PM/Target, and no tests are checked.
        // Ignore Input Date/Day since we auto-prefill those.
        const deptEmpty = !(r.dept && r.dept.value);
        const equipEmpty = !(
            (r.equip && r.equip.value && r.equip.value !== 'Add New') ||
            (r.equip && r.equip.value === 'Add New' && r.equipNew && r.equipNew.value)
        );
        const pmEmpty = !(r.pm && r.pm.value);
        const targetEmpty = !(r.target && r.target.value);
        const noTests = !(r.tests && r.tests.some(cb => cb.checked));
        return deptEmpty && equipEmpty && pmEmpty && targetEmpty && noTests;
    }

    function wireRowHandlers(i) {
        const r = rowSelectors(i);
        const trigger = () => {
            const last = getMaxIndex();
            if (i === last && isRowFilled(i)) {
                addNewRow();
            }
            // When a row transitions to filled, run a duplicate check
            if (isRowFilled(i)) {
                try { checkDuplicateForRow(i); } catch(e) { console.warn('dup-check error', e); }
            }
        };
        [r.dept, r.equip, r.equipNew, r.date, r.pm, r.sched, r.target].forEach(el => {
            if (el) el.addEventListener('change', trigger);
        });
        r.tests.forEach(cb => cb.addEventListener('change', trigger));
    }

    function addNewRow() {
        const tmpl = document.getElementById('templateRow');
        if (!tmpl) return;
        const i = getMaxIndex() + 1;
        const tr = tmpl.cloneNode(true);
        tr.id = '';
        tr.style.display = '';
        // Enable fields and remap ids/names
        tr.querySelectorAll('[id], [name]').forEach(el => {
            if (el.hasAttribute('disabled')) el.removeAttribute('disabled');
            if (el.id) el.id = el.id.replace('_template', '_' + i);
            if (el.name) el.name = el.name.replace('_template', '_' + i);
            // Reset values/checked
            if (el.tagName === 'INPUT') {
                if (el.type === 'checkbox') el.checked = false; else el.value = '';
            } else if (el.tagName === 'SELECT') {
                el.selectedIndex = 0;
            }
        });
        // Insert row
        const tbody = document.querySelector('#plannerTable tbody');
        tbody.appendChild(tr);
        // Hook dynamic behaviors
    const deptSel = document.getElementById('department_' + i);
    const equipSel = document.getElementById('equipment_' + i);
    const equipNew = document.getElementById('equipment_new_' + i);
        if (deptSel) deptSel.addEventListener('change', () => onDepartmentChange(deptSel, 'equipment_' + i, 'equipment_new_' + i));
        if (equipSel) equipSel.addEventListener('change', () => onEquipmentChange(equipSel, 'equipment_new_' + i));
    const dateEl = document.getElementById('date_' + i);
    const dayEl = document.getElementById('day_' + i);
    const pmEl = document.getElementById('pm_date_' + i);
    const pmWeekEl = document.getElementById('pm_week_' + i);
    const schedEl = document.getElementById('schedule_type_' + i);
        if (dateEl) {
            // Prefill with today and mirror non-editable behavior like first row
            const todayStr = todayLocalStr();
            if (!dateEl.value) dateEl.value = todayStr;
            // Block interaction and tabbing
            dateEl.readOnly = true;
            dateEl.setAttribute('tabindex', '-1');
            dateEl.setAttribute('aria-readonly', 'true');
            dateEl.style.pointerEvents = 'none';
            dateEl.style.background = '#f7f7f7';
            // Update day from date
            updateDay(dateEl);
            // Still wire change for programmatic updates (if any)
            dateEl.addEventListener('change', () => updateDay(dateEl));
        }
        if (pmWeekEl) {
            pmWeekEl.readOnly = true;
            pmWeekEl.setAttribute('tabindex', '-1');
            pmWeekEl.setAttribute('aria-readonly', 'true');
            pmWeekEl.style.pointerEvents = 'none';
            pmWeekEl.style.background = '#f7f7f7';
        }
        if (pmEl) {
            // Initialize and wire PM week computation
            updatePmWeekFor(pmEl);
            pmEl.addEventListener('change', () => updatePmWeekFor(pmEl));
        }
        if (dayEl) {
            dayEl.readOnly = true;
            dayEl.setAttribute('tabindex', '-1');
            dayEl.setAttribute('aria-readonly', 'true');
            dayEl.style.pointerEvents = 'none';
            dayEl.style.background = '#f7f7f7';
        }
        // Default schedule type to Planned for new rows
        if (schedEl) {
            try { schedEl.value = 'Planned'; if (typeof updateScheduleColor === 'function') updateScheduleColor(schedEl); } catch(e) {}
        }
        // Make sure equipment options reset according to dept
        populateEquipmentOptions(equipSel, deptSel ? deptSel.value : '');
        // Wire auto-add on changes
        wireRowHandlers(i);
    }

    // Initialize existing department/equipment selects on page load
    document.addEventListener('DOMContentLoaded', () => {
    // For each department select on the page, populate its equipment select if a value exists
        document.querySelectorAll('select[id^="department_"]').forEach(deptSel => {
            const suffix = deptSel.id.split('department_')[1];
            const equipmentId = 'equipment_' + suffix;
            const equipmentNewId = 'equipment_new_' + suffix;
            const equipmentSel = document.getElementById(equipmentId);
            // populate (even if dept empty, will create default option)
            populateEquipmentOptions(equipmentSel, deptSel.value);
            // if dept was Add New, ensure inputs are enabled
            if (deptSel.value === 'Add New') onDepartmentChange(deptSel, equipmentId, equipmentNewId);
            // if equipment already set to Add New, toggle new input
            if (equipmentSel && equipmentSel.value === 'Add New') onEquipmentChange(equipmentSel, equipmentNewId);
        });

    // wire row 0 for auto-add
    wireRowHandlers(0);

        // Also handle template row ids
        const deptTemplate = document.getElementById('department_template');
        if (deptTemplate) {
            populateEquipmentOptions(document.getElementById('equipment_template'), deptTemplate.value);
        }
            // Disable past dates and initialize day fields for any date inputs on page
            const todayStr = todayLocalStr();
            document.querySelectorAll('input[type="date"]').forEach(d => {
                try { d.min = todayStr; } catch(e) {}
                if (d.value) updateDay(d);
            });
            // Initialize PM week numbers and wire changes
            document.querySelectorAll('input[id^="pm_date_"]').forEach(pm => {
                if (pm.value) updatePmWeekFor(pm);
                pm.addEventListener('change', () => updatePmWeekFor(pm));
            });

        // Prefill current year/week and today's input date for the first row
        try {
            const now = new Date();
            const weekInput = document.getElementById('week_number');
            const yearInput = document.getElementById('year');
            if (weekInput) {
                try { weekInput.value = getISOWeek(now); } catch(e) {}
            }
            if (yearInput) {
                yearInput.value = now.getFullYear();
            }
            const date0 = document.getElementById('date_0');
            if (date0) {
                // Always set to today's local date to avoid stale default from previous day
                const todayStr0 = todayLocalStr();
                date0.value = todayStr0;
                updateDay(date0); // this will also populate the Day and ensure week/year
            }
        } catch (e) { /* ignore */ }

        // Remove trailing empty row when Done is checked
        const doneCb = document.getElementById('done_checkbox');
        if (doneCb) {
            doneCb.addEventListener('change', () => {
                if (doneCb.checked) {
                    const last = getMaxIndex();
                    if (last >= 1 && isRowEmpty(last)) {
                        const lastRow = document.getElementById('date_' + last)?.closest('tr');
                        if (lastRow) lastRow.remove();
                    }
                } else {
                    // When unchecked, ensure there is one trailing empty row
                    const last = getMaxIndex();
                    if (last >= 0 && !isRowEmpty(last)) {
                        addNewRow();
                    }
                }
            });
        }
    });

    // --- Duplicate checking ---
    function updatePmWeekFor(pmDateInput) {
        try {
            if (!pmDateInput) return;
            const val = pmDateInput.value;
            const idx = pmDateInput.id.replace('pm_date_', '');
            const pmWeekInput = document.getElementById('pm_week_' + idx);
            if (!pmWeekInput) return;
            if (!val) { pmWeekInput.value = ''; return; }
            const dt = new Date(val + 'T00:00:00');
            pmWeekInput.value = getISOWeek(dt);
        } catch (e) {
            console.warn('updatePmWeekFor error', e);
        }
    }
    async function checkDuplicateForRow(i) {
        const r = rowSelectors(i);
        if (!r.dept || !r.equip || !r.pm || !r.sched) return;
        // Only attempt if department, equipment, pm_date (or date), and schedule have values and at least one test selected.
        const anyTest = r.tests && r.tests.some(cb => cb.checked);
        const dept = r.dept.value;
        const dept_new = document.getElementById('department_new_' + i)?.value || '';
        const equip = r.equip.value;
        const equip_new = r.equipNew?.value || '';
        const dateVal = r.date?.value || '';
        const pmDate = r.pm.value || '';
        const sched = r.sched.value || '';
        const week = document.getElementById('week_number')?.value || '';
        const year = document.getElementById('year')?.value || '';
        if (!(dept && (equip || (equip==='Add New' && equip_new)) && (pmDate || dateVal) && sched && anyTest)) return;
        const payload = { department: dept, department_new: dept_new, equipment: equip, equipment_new: equip_new, date: dateVal, pm_date: pmDate, schedule_type: sched, week_number: week, year: year };
        let resp;
        try {
            resp = await fetch('/api/planner/check_duplicate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        } catch (e) { return; }
        if (!resp.ok) return;
        let data; try { data = await resp.json(); } catch(e) { return; }
        if (!data || !data.ok) return;
        const matches = data.matches || [];
        if (matches.length === 0) return;
        // Build message
        const lines = [];
        lines.push(`Your input matches ${matches.length} existing planner entr${matches.length>1?'ies':'y'}:`);
        lines.push('<ul style="margin:8px 0 0 16px;">');
        matches.slice(0, 10).forEach(m => {
            const dt = (m.pm_date || m.date || '').toString().slice(0,10);
            lines.push(`<li><strong>ID ${m.id}</strong> â€” ${m.department} / ${m.equipment} â€” ${dt} â€” ${m.schedule_type || ''} (W${m.week_number}, ${m.year})</li>`);
        });
        lines.push('</ul>');
        // Show modal with message
        showDupModal(lines.join(''));
    }

        function showDupModal(html) {
        const modal = document.getElementById('dupModal');
        const body = document.getElementById('dupBody');
        const btn = document.getElementById('dupDismiss');
        if (!modal || !body || !btn) return;
        body.innerHTML = html;
        modal.style.display = 'flex';
        const close = () => { modal.style.display = 'none'; body.innerHTML = ''; btn.removeEventListener('click', close); };
        btn.addEventListener('click', close);
        modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
    }

        // Add Test Type modal wiring (reuse planner_entries behavior)
        document.addEventListener('click', function(e) {
                const target = e.target.closest('[data-action="open-modal"]');
                if (!target) return;
                const pid = target.getAttribute('data-pid');
                const modal = document.getElementById('addTypeModal');
                if (!modal) return;
                document.getElementById('addTypePlannerId').value = pid;
                modal.classList.remove('hidden');
        });
        document.addEventListener('click', function(e) {
                if (e.target.getAttribute('data-action') === 'close-modal') {
                        const modal = document.getElementById('addTypeModal');
                        if (modal) modal.classList.add('hidden');
                }
        });
</script>

<!-- Add Test Type Modal (shared with planner_entries UX) -->
<div id="addTypeModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-dialog" role="document" aria-labelledby="addTypeTitle">
        <header class="modal-header">
            <h3 id="addTypeTitle">Add Testing Type</h3>
            <button type="button" class="close-btn" aria-label="Close modal" data-action="close-modal">Ã—</button>
        </header>
        <form id="addTypeForm" method="post" action="/planner/add_test_type" class="modal-form">
            <input type="hidden" name="planner_id" id="addTypePlannerId">
            <input type="hidden" name="next" value="/planner">
            <label class="field">
                <span class="field-label">Select type</span>
                <select name="test_type" id="addTypeSelect" required>
                    <option value="">-- Choose --</option>
                    <option>Vibration Analysis</option>
                    <option>Oil Analysis</option>
                    <option>Thermal Imaging</option>
                    <option>Ultrasonic Analysis</option>
                    <option>Motor Dynamic Analysis</option>
                    <option>Ultrasonic Leak Detection</option>
                    <option>Dynamic Balancing</option>
                    <option>Other</option>
                </select>
            </label>
            <div class="actions">
                <button type="button" class="btn btn-ghost" data-action="close-modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Add</button>
            </div>
        </form>
    </div>
    </div>
{% endblock %}
