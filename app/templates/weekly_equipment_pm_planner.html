<title>CBM â€¢ Manual Scheduling</title>
{% extends 'technician/_planner_base.html' %}
{% block planner_content %}
<main class="planner-container">
    <form method="POST" action="/planner" class="planner-form" id="plannerForm">
        <div class="form-group">
            <label for="week_number">Week Number:</label>
            <input type="number" id="week_number" name="week_number" min="1" max="52" required>
            <label for="year">Year:</label>
            <input type="number" id="year" name="year" required>
        </div>

        <table id="plannerTable" class="planner-table">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Equipment</th>
                    <th>Input Date</th>
                    <th>Day</th>
                    <th>Testing Type</th>
                    <th>PM Date</th>
                    <th>Schedule Type</th>
                    <th>Proposed Target Date</th>
                </tr>
            </thead>
            <tbody>
                <!-- hidden template row -->
                <tr id="templateRow" style="display:none;">
                    <td>
                        <select name="department_template" id="department_template" onchange="onDepartmentChange(this, 'equipment_template', 'equipment_new_template')" required disabled>
                            <option value="">Select Department</option>
                            {% for dept in department_list %}
                                <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                            <option value="Add New">Add New</option>
                        </select>
                        <input type="text" name="department_new_template" id="department_new_template" placeholder="Enter new department" class="hidden-input" disabled>
                    </td>
                    <td>
                        <select name="equipment_template" id="equipment_template" onchange="onEquipmentChange(this, 'equipment_new_template')" required disabled>
                            <option value="">Select Equipment</option>
                        </select>
                        <input type="text" name="equipment_new_template" id="equipment_new_template" placeholder="Enter new equipment" class="hidden-input" disabled>
                    </td>
                    <td><input type="date" name="date_template" id="date_template" required onchange="updateDay(this)" disabled></td>
                    <td><input type="text" name="day_template" id="day_template" placeholder="Day" readonly disabled></td>
                    <td>
                        <div class="testing-grid">
                            <label><input type="checkbox" name="testing_template" value="Vibration Analysis" disabled> <span class="tag va">Vibration Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Oil Analysis" disabled> <span class="tag oil">Oil Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Thermal Imaging" disabled> <span class="tag thermal">Thermal Imaging</span></label>
                            <label><input type="checkbox" name="testing_template" value="Ultrasonic Analysis" disabled> <span class="tag ultra">Ultrasonic Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Motor Dynamic Analysis" disabled> <span class="tag mda">Motor Dynamic Analysis</span></label>
                            <label><input type="checkbox" name="testing_template" value="Ultrasonic Leak Detection" disabled> <span class="tag leak">Ultrasonic Leak Detection</span></label>
                            <label><input type="checkbox" name="testing_template" value="Dynamic Balancing" disabled> <span class="tag balance">Dynamic Balancing</span></label>
                            <label><input type="checkbox" name="testing_template" value="Other" disabled> <span class="tag other">Other</span></label>
                        </div>
                    </td>
                    <td><input type="date" name="pm_date_template" id="pm_date_template" required disabled></td>
                    <td>
                        <select name="schedule_type_template" id="schedule_type_template" required disabled onchange="updateScheduleColor(this)">
                            <option value="">Select</option>
                            <option value="Planned" selected>Planned</option>
                            <option value="Unplanned">Unplanned</option>
                            <option value="Validation">Validation</option>
                        </select>
                    </td>
                    <td><input type="date" name="proposed_target_date_template" id="proposed_target_date_template" required disabled></td>
                </tr>

                <!-- first live row -->
                <tr>
                    <td>
                        <select name="department_0" id="department_0" onchange="onDepartmentChange(this, 'equipment_0', 'equipment_new_0')" required>
                            <option value="">Select Department</option>
                            {% for dept in department_list %}
                                <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                            <option value="Add New">Add New</option>
                        </select>
                        <input type="text" name="department_new_0" id="department_new_0" placeholder="Enter new department" class="hidden-input">
                    </td>
                    <td>
                        <select name="equipment_0" id="equipment_0" onchange="onEquipmentChange(this, 'equipment_new_0')" required>
                            <option value="">Select Equipment</option>
                        </select>
                        <input type="text" name="equipment_new_0" id="equipment_new_0" placeholder="Enter new equipment" class="hidden-input">
                    </td>
                    <td><input type="date" name="date_0" id="date_0" required onchange="updateDay(this)"></td>
                    <td><input type="text" name="day_0" id="day_0" placeholder="Day" readonly></td>
                    <td>
                        <div class="testing-grid">
                            <label><input type="checkbox" name="testing_0" value="Vibration Analysis"> <span class="tag va">Vibration Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Oil Analysis"> <span class="tag oil">Oil Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Thermal Imaging"> <span class="tag thermal">Thermal Imaging</span></label>
                            <label><input type="checkbox" name="testing_0" value="Ultrasonic Analysis"> <span class="tag ultra">Ultrasonic Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Motor Dynamic Analysis"> <span class="tag mda">Motor Dynamic Analysis</span></label>
                            <label><input type="checkbox" name="testing_0" value="Ultrasonic Leak Detection"> <span class="tag leak">Ultrasonic Leak Detection</span></label>
                            <label><input type="checkbox" name="testing_0" value="Dynamic Balancing"> <span class="tag balance">Dynamic Balancing</span></label>
                            <label><input type="checkbox" name="testing_0" value="Other"> <span class="tag other">Other</span></label>
                        </div>
                    </td>
                    <td><input type="date" name="pm_date_0" id="pm_date_0" required></td>
                    <td>
                        <select name="schedule_type_0" id="schedule_type_0" required onchange="updateScheduleColor(this)">
                            <option value="">Select</option>
                            <option value="Planned" selected>Planned</option>
                            <option value="Unplanned">Unplanned</option>
                            <option value="Validation">Validation</option>
                        </select>
                    </td>
                    <td><input type="date" name="proposed_target_date_0" id="proposed_target_date_0" required></td>
                </tr>
            </tbody>
        </table>

        <div class="form-actions">
            <label><input type="checkbox" id="done_checkbox"> Done</label>
            <button type="submit" class="btn-primary">Submit</button>
        </div>
    </form>
</main>

{% if recent_planners and recent_planners|length > 0 %}
<section class="planner-container" style="margin-top: 20px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap;">
        <h3 style="margin: 0;">Planner Entries</h3>
        <form id="filterForm" method="GET" action="/planner" style="display:flex; align-items:center; gap:8px;">
            <label for="filter_week">Week:</label>
            <input type="number" min="1" max="52" id="filter_week" name="filter_week" value="{{ filter_week }}" style="width: 5rem;" placeholder="1-52">
            <label for="filter_year">Year:</label>
            <input type="number" id="filter_year" name="filter_year" value="{{ filter_year }}" style="width: 6rem;">
            <label for="filter_department">Department:</label>
            <select id="filter_department" name="filter_department">
                <option value="">All</option>
                {% for dept in department_list %}
                    <option value="{{ dept }}" {% if filter_department == dept %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn-primary">Filter</button>
            <a href="/planner" class="btn-secondary" style="text-decoration:none; padding:6px 10px; border:1px solid #aaa; border-radius:4px;">Reset</a>
        </form>
    </div>
    <table class="planner-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Week</th>
                <th>Year</th>
                <th>Department</th>
                <th>Equipment</th>
                <th>Date</th>
                <th>Day</th>
                <th>PM Date</th>
                <th>PM Week</th>
            </tr>
        </thead>
        <tbody>
            {% for p in recent_planners %}
            <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.week_number }}</td>
                <td>{{ p.year }}</td>
                <td>{{ p.department }}</td>
                <td>{{ p.equipment }}</td>
                <td>{{ p.date }}</td>
                <td>{{ p.day }}</td>
                <td>{{ p.pm_date or '' }}</td>
                <td>{{ p.pm_week_number if p.pm_week_number is not none else '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endif %}

<script id="deptEquipData" type="application/json">{{ department_equipment_map | tojson | safe }}</script>
<script>
    // Populate Day field from Date input and optionally set week/year.
    function getISOWeek(d) {
        // d: Date object
        const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        // ISO week starts on Monday. getUTCDay: 0 (Sun) - 6 (Sat); convert 0->7
        const dayNum = date.getUTCDay() || 7;
        // Set to Thursday in current week: date + 4 - dayNum
        date.setUTCDate(date.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
        const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
        return weekNo;
    }

    function updateDay(dateInput) {
        try {
            if (!dateInput) return;
            const id = dateInput.id; // e.g., date_0 or date_template
            const dayId = id.replace('date', 'day');
            const dayInput = document.getElementById(dayId);
            const val = dateInput.value;
            if (!dayInput) return;
            if (!val) { dayInput.value = ''; return; }
            // Use local Date parsing for YYYY-MM-DD
            const dt = new Date(val + 'T00:00:00');
            const names = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            dayInput.value = names[dt.getDay()];

            // If main week/year inputs exist and are empty, auto-fill them from this date
            const weekInput = document.getElementById('week_number');
            const yearInput = document.getElementById('year');
            if (weekInput && yearInput) {
                try {
                    const isoWeek = getISOWeek(dt);
                    weekInput.value = isoWeek;
                    yearInput.value = dt.getFullYear();
                } catch(e) {
                    // swallow
                }
            }
        } catch(e) {
            console.error('updateDay error', e);
        }
    }

    // Cascade equipment options when a Department is selected and toggle "Add New" inputs.
    const deptEquipMap = (function(){
        try {
            const el = document.getElementById('deptEquipData');
            return el ? JSON.parse(el.textContent || '{}') : {};
        } catch(e) { console.error('Failed to parse deptEquipData', e); return {}; }
    })();

    function populateEquipmentOptions(equipmentSelect, dept) {
        if (!equipmentSelect) return;
        // clear existing
        equipmentSelect.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select Equipment';
        equipmentSelect.appendChild(defaultOpt);

        if (!dept) return;
        const list = deptEquipMap[dept] || [];
        list.forEach(eq => {
            const opt = document.createElement('option');
            opt.value = eq;
            opt.textContent = eq;
            equipmentSelect.appendChild(opt);
        });
        const addOpt = document.createElement('option');
        addOpt.value = 'Add New';
        addOpt.textContent = 'Add New';
        equipmentSelect.appendChild(addOpt);
    }

    function onDepartmentChange(deptSelect, equipmentId, equipmentNewId) {
        try {
            const deptVal = deptSelect.value;
            const equipmentSelect = document.getElementById(equipmentId);
            const equipmentNewInput = document.getElementById(equipmentNewId);
            // Toggle department new input (id pattern: department_new_X)
            const deptNewId = deptSelect.id.replace('department', 'department_new');
            const deptNewInput = document.getElementById(deptNewId);

            if (deptVal === 'Add New') {
                if (deptNewInput) { deptNewInput.disabled = false; deptNewInput.classList.remove('hidden-input'); }
                // clear equipment options and allow adding new equipment
                if (equipmentSelect) { equipmentSelect.innerHTML = ''; const o = document.createElement('option'); o.value='Add New'; o.textContent='Add New'; equipmentSelect.appendChild(o); equipmentSelect.value = 'Add New'; }
                if (equipmentNewInput) { equipmentNewInput.disabled = false; equipmentNewInput.classList.remove('hidden-input'); }
            } else {
                if (deptNewInput) { deptNewInput.disabled = true; deptNewInput.classList.add('hidden-input'); deptNewInput.value = ''; }
                populateEquipmentOptions(equipmentSelect, deptVal);
                if (equipmentNewInput) { equipmentNewInput.disabled = true; equipmentNewInput.classList.add('hidden-input'); equipmentNewInput.value = ''; }
            }
        } catch (e) {
            console.error('onDepartmentChange error', e);
        }
    }

    function onEquipmentChange(equipmentSelect, equipmentNewId) {
        try {
            const eqVal = equipmentSelect.value;
            const eqNewInput = document.getElementById(equipmentNewId);
            if (eqVal === 'Add New') {
                if (eqNewInput) { eqNewInput.disabled = false; eqNewInput.classList.remove('hidden-input'); }
            } else {
                if (eqNewInput) { eqNewInput.disabled = true; eqNewInput.classList.add('hidden-input'); eqNewInput.value = ''; }
            }
        } catch (e) {
            console.error('onEquipmentChange error', e);
        }
    }

    // Initialize existing department/equipment selects on page load
    document.addEventListener('DOMContentLoaded', () => {
        // For each department select on the page, populate its equipment select if a value exists
        document.querySelectorAll('select[id^="department_"]').forEach(deptSel => {
            const suffix = deptSel.id.split('department_')[1];
            const equipmentId = 'equipment_' + suffix;
            const equipmentNewId = 'equipment_new_' + suffix;
            const equipmentSel = document.getElementById(equipmentId);
            // populate (even if dept empty, will create default option)
            populateEquipmentOptions(equipmentSel, deptSel.value);
            // if dept was Add New, ensure inputs are enabled
            if (deptSel.value === 'Add New') onDepartmentChange(deptSel, equipmentId, equipmentNewId);
            // if equipment already set to Add New, toggle new input
            if (equipmentSel && equipmentSel.value === 'Add New') onEquipmentChange(equipmentSel, equipmentNewId);
        });

        // Also handle template row ids
        const deptTemplate = document.getElementById('department_template');
        if (deptTemplate) {
            populateEquipmentOptions(document.getElementById('equipment_template'), deptTemplate.value);
        }
            // Disable past dates and initialize day fields for any date inputs on page
            const todayStr = new Date().toISOString().slice(0,10);
            document.querySelectorAll('input[type="date"]').forEach(d => {
                try { d.min = todayStr; } catch(e) {}
                if (d.value) updateDay(d);
            });
    });
</script>
{% endblock %}
