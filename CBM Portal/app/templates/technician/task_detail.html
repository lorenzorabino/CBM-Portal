<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Detail</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/main.js" defer></script>
</head>
<body>
  <div id="toast-root" class="toast-container" aria-live="polite" aria-atomic="true"></div>
  <header class="page-header">
    <h1>Task #{{ task.id }}</h1>
    <a class="btn-secondary" href="{{ url_for('technician.dashboard') }}" style="margin-left:auto;">Back to Dashboard</a>
  </header>
  <main class="container">
    <div>
      <p><strong>Planner:</strong> {{ task.planner_id }} (Week {{ task.week_number }}, {{ task.year }})</p>
      <p><strong>Department:</strong> {{ task.department }} | <strong>Equipment:</strong> {{ task.equipment }}</p>
      <p><strong>Test Type:</strong> {{ task.test_type }}</p>
  <p><strong>Status:</strong> <span data-status-text="{{ task.status }}">{{ task.status }}</span> | <strong>Alarm:</strong> <span data-alarm-text="{{ task.alarm_level or '-' }}">{{ task.alarm_level or '-' }}</span></p>
      <p><strong>Date:</strong> {{ task.test_date or '-' }}</p>
      <p><strong>Notes:</strong> {{ task.notes or '-' }}</p>
    </div>
    <section style="margin-top:16px;">
      <h3>Attachments</h3>
  {% if attachments and attachments|length %}
    <ul style="font-size:12px; color:#555;">
          {% for a in attachments %}
            <li>
              <a href="{{ url_for('technician.view_attachment', attachment_id=a.id) }}" target="_blank" rel="noopener" style="display:inline-block; max-width: 320px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ a.filename }}</a>
              <small style="color:#666;">(uploaded {{ a.uploaded_at }})</small>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No attachments yet.</p>
      {% endif %}
      <form class="inline" method="post" enctype="multipart/form-data" action="{{ url_for('technician.upload_attachments', task_id=task.id) }}">
        <input type="hidden" name="next" value="{{ request.full_path }}" />
        <input type="file" name="files" multiple />
        <button class="btn" type="submit">Upload</button>
      </form>
    </section>
    <section style="margin-top:16px;">
      <h3>Update</h3>
      <form class="inline" method="post" action="{{ url_for('technician.task_update', task_id=task.id) }}">
        <input type="hidden" name="next" value="{{ request.full_path }}" />
        <label>Status:
          <select name="status">
            {% set s = task.status or '' %}
            <option value="Ongoing" {% if s|lower in ['ongoing','todo'] %}selected{% endif %}>Ongoing</option>
            <option value="Completed" {% if s|lower in ['completed','done'] %}selected{% endif %}>Completed</option>
            <option value="Ongoing Analysis" {% if s == 'Ongoing Analysis' %}selected{% endif %}>Ongoing Analysis</option>
            <option value="For Revisit" {% if s == 'For Revisit' %}selected{% endif %}>For Revisit</option>
            <option value="Waived" {% if s == 'Waived' %}selected{% endif %}>Waived</option>
            <option value="Sending Report" {% if s == 'Sending Report' %}selected{% endif %}>Sending Report</option>
          </select>
        </label>
        <label>Alarm:
          {% set a = task.alarm_level or 'Normal' %}
          <select name="alarm_level">
            <option value="Normal" {% if a == 'Normal' %}selected{% endif %}>Normal</option>
            <option value="Warning" {% if a == 'Warning' %}selected{% endif %}>Warning</option>
            <option value="Critical" {% if a == 'Critical' %}selected{% endif %}>Critical</option>
          </select>
        </label>
        <input type="text" name="notes" value="{{ task.notes or '' }}" placeholder="Remarks" style="width:240px;" />
        <button class="btn" type="submit">Save</button>
      </form>
    </section>
  </main>
  <script>
    (function() {
      const root = document.getElementById('toast-root');
      if (!root) return;
      const msgs = [];
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            msgs.push({ c: {{ (category or 'message')|tojson }}, m: {{ message|tojson }} });
          {% endfor %}
        {% endif %}
      {% endwith %}
      function show(text, cat) {
        const n = document.createElement('div');
        n.className = 'toast ' + (cat ? ('toast-' + cat) : 'toast-message');
        n.textContent = text;
        root.appendChild(n);
        void n.offsetWidth; n.classList.add('show');
        setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 200); }, 1000);
      }
      msgs.forEach(x => show(x.m, x.c));
    })();
  </script>
</body>
</html>
